<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JazzDex</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:wght@400;600;700&family=Barlow:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê BRAND COLORS ‚ïê‚ïê */
:root {
  --navy:#002B5C; --gold:#F9A01B; --teal:#00B2A9;
  --red:#C8102E; --cream:#F5F0E8; --bg:#001525;
  --common:#00B2A9; --rare:#7C4DFF; --epic:#FF6D00; --legendary:#F9A01B;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--cream);font-family:'Barlow',sans-serif;min-height:100vh;overflow-x:hidden;}

/* HEADER */
header{background:linear-gradient(135deg,#002044,#001020);border-bottom:3px solid var(--gold);padding:10px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:4px;color:var(--gold);text-shadow:0 0 24px rgba(249,160,27,.5);}
.logo span{color:var(--teal);}
.hdr-right{display:flex;align-items:center;gap:16px;}
.hdr-stats{font-family:'Barlow Condensed',sans-serif;font-size:.85rem;color:rgba(245,240,232,.55);display:flex;gap:16px;}
.hdr-stats strong{color:var(--gold);font-size:1.1rem;}
.save-badge{font-family:'Barlow Condensed',sans-serif;font-size:.7rem;color:rgba(245,240,232,.3);opacity:0;transition:opacity .3s;}

/* NAV */
nav{background:var(--navy);display:flex;justify-content:center;gap:3px;padding:6px 10px;border-bottom:1px solid rgba(249,160,27,.2);flex-wrap:wrap;}
.nav-btn{background:transparent;border:2px solid transparent;color:rgba(245,240,232,.55);font-family:'Barlow Condensed',sans-serif;font-size:.88rem;font-weight:700;letter-spacing:1px;padding:6px 14px;cursor:pointer;border-radius:4px;transition:all .2s;text-transform:uppercase;}
.nav-btn:hover{color:var(--gold);border-color:rgba(249,160,27,.3);}
.nav-btn.active{background:var(--gold);color:var(--navy);border-color:var(--gold);}

/* VIEWS */
.view{display:none;}.view.active{display:block;}
.view-inner{padding:20px;max-width:960px;margin:0 auto;}
.view-title{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:3px;color:var(--gold);margin-bottom:16px;display:flex;align-items:center;gap:10px;}
.view-title::after{content:'';flex:1;height:2px;background:linear-gradient(90deg,rgba(249,160,27,.5),transparent);}

/* COURT FLOOR */
.court-wrap{position:relative;width:100%;max-width:960px;margin:0 auto;overflow:hidden;border-left:4px solid var(--gold);border-right:4px solid var(--gold);}
.court-wrap::before{content:'';display:block;padding-top:54%;}
.court-wrap svg.floor{position:absolute;inset:0;width:100%;height:100%;}

/* MAP SPAWNS */
.spawn-char{position:absolute;transform:translate(-50%,-100%);cursor:pointer;z-index:20;transition:left 9s ease-in-out,top 9s ease-in-out;display:flex;flex-direction:column;align-items:center;}
.spawn-char.popin{animation:pop-in .4s cubic-bezier(.175,.885,.32,1.275) forwards;}
.spawn-char.popout{animation:pop-out .3s ease-in forwards;pointer-events:none;}
@keyframes pop-in{from{transform:translate(-50%,-100%) scale(0);opacity:0}to{transform:translate(-50%,-100%) scale(1);opacity:1}}
@keyframes pop-out{to{transform:translate(-50%,-100%) scale(0) rotate(12deg);opacity:0}}
.char-body{display:flex;flex-direction:column;align-items:center;}
.char-shadow{width:26px;height:6px;background:rgba(0,0,0,.4);border-radius:50%;margin-top:-2px;animation:sh-bob 1.8s ease-in-out infinite;}
@keyframes sh-bob{0%,100%{transform:scaleX(1)}50%{transform:scaleX(.6)}}
.char-tag{font-family:'Barlow Condensed',sans-serif;font-size:.6rem;font-weight:700;background:rgba(0,0,0,.8);padding:2px 6px;border-radius:3px;white-space:nowrap;margin-top:4px;letter-spacing:.4px;border-left:2px solid currentColor;}
.map-legend{background:var(--navy);padding:10px 20px;display:flex;gap:16px;flex-wrap:wrap;align-items:center;font-family:'Barlow Condensed',sans-serif;font-size:.82rem;border-top:1px solid rgba(249,160,27,.2);max-width:960px;margin:0 auto;}
.leg-item{display:flex;align-items:center;gap:6px;}
.leg-dot{width:10px;height:10px;border-radius:50%;}
.map-hint{color:rgba(245,240,232,.4);font-size:.78rem;margin-left:auto;font-style:italic;}

/* CATCH MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,8,25,.93);z-index:300;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.modal-overlay.open{display:flex;}
.catch-modal{background:linear-gradient(160deg,#001830,#002244);border:2px solid var(--gold);border-radius:18px;padding:24px 28px;width:min(440px,96vw);position:relative;box-shadow:0 0 80px rgba(249,160,27,.2);animation:modal-in .35s cubic-bezier(.175,.885,.32,1.275);}
@keyframes modal-in{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.modal-close{position:absolute;top:12px;right:14px;background:none;border:none;color:rgba(255,255,255,.4);font-size:1.4rem;cursor:pointer;}
.modal-close:hover{color:#fff;}
.modal-header{display:flex;align-items:center;gap:16px;margin-bottom:16px;}
.modal-char{flex-shrink:0;}.modal-info{flex:1;}
.modal-name{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:3px;color:var(--gold);line-height:1;}
.modal-rbadge{font-family:'Barlow Condensed',sans-serif;font-size:.72rem;font-weight:700;letter-spacing:2px;padding:2px 10px;border-radius:20px;text-transform:uppercase;display:inline-block;margin-top:4px;}
.hoop-section{background:rgba(0,0,0,.35);border-radius:12px;padding:16px;}
.hoop-title{font-family:'Barlow Condensed',sans-serif;font-size:.85rem;color:rgba(245,240,232,.6);text-align:center;margin-bottom:10px;letter-spacing:1px;}
.shot-row{display:flex;justify-content:center;gap:10px;margin-bottom:10px;}
.shot-pip{width:32px;height:32px;border-radius:50%;border:2px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:.9rem;transition:all .25s;}
.shot-pip.made{background:var(--gold);border-color:var(--gold);transform:scale(1.1);}
.shot-pip.miss{background:var(--red);border-color:var(--red);}
.shot-pip.pending{opacity:.4;}
canvas#hoop-cv{width:100%;height:150px;display:block;border-radius:8px;background:rgba(0,0,10,.4);}
.throw-btn{margin-top:10px;width:100%;background:linear-gradient(135deg,var(--gold),#c87c00);color:var(--navy);border:none;font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:3px;padding:10px;border-radius:8px;cursor:pointer;box-shadow:0 4px 18px rgba(249,160,27,.35);transition:transform .1s;}
.throw-btn:active{transform:scale(.97);}.throw-btn:disabled{opacity:.35;cursor:not-allowed;}
.fail-msg{display:none;text-align:center;color:var(--red);font-family:'Barlow Condensed',sans-serif;font-size:1rem;margin-top:8px;}
.success-screen{display:none;text-align:center;padding:16px 0;}
.success-screen h3{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--gold);letter-spacing:4px;}
.success-screen p{font-family:'Barlow Condensed',sans-serif;color:rgba(245,240,232,.7);}
.burst{font-size:2.8rem;display:block;margin-bottom:8px;animation:burst .5s ease 4;}
@keyframes burst{0%,100%{transform:scale(1)}50%{transform:scale(1.4)}}

/* PLAYER CARDS */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:16px;}
.card-flip-wrap{perspective:700px;height:270px;cursor:pointer;position:relative;}
.card-inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .55s cubic-bezier(.4,0,.2,1);border-radius:14px;}
.card-flip-wrap.flipped .card-inner{transform:rotateY(180deg);}
.card-face{position:absolute;inset:0;backface-visibility:hidden;border-radius:14px;overflow:hidden;background:linear-gradient(160deg,#001830,var(--navy));}
.card-back{transform:rotateY(180deg);}
.card-flip-wrap[data-r="common"] .card-face{border:2px solid var(--common);box-shadow:0 4px 16px rgba(0,178,169,.2);}
.card-flip-wrap[data-r="rare"] .card-face{border:2px solid var(--rare);box-shadow:0 4px 16px rgba(124,77,255,.25);}
.card-flip-wrap[data-r="epic"] .card-face{border:2px solid var(--epic);box-shadow:0 4px 20px rgba(255,109,0,.3);}
.card-flip-wrap[data-r="legendary"] .card-face{border:2px solid var(--legendary);box-shadow:0 4px 28px rgba(249,160,27,.4);animation:cardleg 3s ease-in-out infinite;}
@keyframes cardleg{0%,100%{box-shadow:0 4px 28px rgba(249,160,27,.4)}50%{box-shadow:0 4px 50px rgba(249,160,27,.7)}}
/* Card count badge ‚Äî always visible, never hides */
.card-count-badge{position:absolute;top:8px;right:8px;z-index:10;background:rgba(0,0,0,.82);color:var(--gold);font-family:'Bebas Neue',sans-serif;font-size:.85rem;padding:2px 8px;border-radius:10px;border:1px solid rgba(249,160,27,.45);pointer-events:none;}
/* Card jersey number badge */
.card-jersey-badge{position:absolute;top:8px;left:8px;z-index:10;background:rgba(0,0,0,.7);color:rgba(245,240,232,.7);font-family:'Bebas Neue',sans-serif;font-size:.8rem;padding:2px 7px;border-radius:10px;pointer-events:none;}
/* Front face */
.card-front-img{width:100%;height:100%;object-fit:cover;display:block;}
.card-front-overlay{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.8));padding:20px 10px 10px;}
.card-front-overlay .card-pname{font-family:'Bebas Neue',sans-serif;font-size:1.25rem;letter-spacing:2px;color:#fff;}
.card-front-overlay .card-rbadge{font-family:'Barlow Condensed',sans-serif;font-size:.6rem;font-weight:700;letter-spacing:2px;padding:2px 7px;border-radius:20px;text-transform:uppercase;display:inline-block;margin-top:2px;}
.card-front-noimg{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:6px;padding:12px;}
.card-front-noimg .card-char{height:90px;display:flex;align-items:flex-end;justify-content:center;}
.card-front-noimg .card-pname{font-family:'Bebas Neue',sans-serif;font-size:1.15rem;letter-spacing:2px;text-align:center;}
.card-front-noimg .card-era{font-family:'Barlow Condensed',sans-serif;font-size:.68rem;color:rgba(245,240,232,.4);text-align:center;}
/* Back face */
.card-back-inner{padding:14px;height:100%;display:flex;flex-direction:column;}
.card-back-num{font-family:'Barlow Condensed',sans-serif;font-size:.7rem;color:rgba(245,240,232,.35);}
.card-back-name{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px;color:var(--gold);line-height:1;margin-bottom:2px;}
.card-back-era{font-family:'Barlow Condensed',sans-serif;font-size:.68rem;color:rgba(245,240,232,.4);margin-bottom:10px;}
.card-back-stats{background:rgba(0,0,0,.3);border-radius:8px;padding:8px 10px;display:grid;grid-template-columns:1fr 1fr;gap:4px 8px;margin-bottom:8px;}
.srow{display:flex;justify-content:space-between;font-family:'Barlow Condensed',sans-serif;font-size:.82rem;}
.sl{color:rgba(245,240,232,.45);}.sv{font-weight:600;}
.card-back-quote{font-family:'Barlow Condensed',sans-serif;font-size:.7rem;color:rgba(245,240,232,.4);font-style:italic;text-align:center;margin-top:auto;padding-top:6px;}
.card-back-hint{font-family:'Barlow Condensed',sans-serif;font-size:.6rem;color:rgba(245,240,232,.2);text-align:center;margin-top:4px;}

/* DEX */
.dex-bar-wrap{background:rgba(0,0,0,.3);border-radius:8px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:14px;}
.dex-track{flex:1;height:12px;background:rgba(0,0,0,.4);border-radius:6px;overflow:hidden;border:1px solid rgba(249,160,27,.2);}
.dex-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--gold));border-radius:6px;transition:width .5s;}
.dex-frac{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--gold);letter-spacing:2px;white-space:nowrap;}
.dex-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(78px,1fr));gap:8px;}
.dex-slot{border:2px solid rgba(249,160,27,.15);border-radius:10px;padding:7px 4px;text-align:center;background:rgba(0,20,50,.5);transition:all .2s;}
.dex-slot.got{border-color:var(--gold);background:rgba(0,30,70,.8);cursor:pointer;}
.dex-slot.got:hover{transform:scale(1.06);}
.dex-char{display:flex;justify-content:center;align-items:flex-end;height:50px;margin-bottom:3px;}
.dex-pname{font-family:'Barlow Condensed',sans-serif;font-size:.62rem;font-weight:700;letter-spacing:.3px;}
.dex-slot:not(.got) .dex-char{filter:brightness(0) opacity(.25);}
.dex-slot:not(.got) .dex-pname{color:rgba(255,255,255,.15);}
/* "missing" highlight for completion hunting */
.dex-slot.missing{border-color:rgba(200,16,46,.55);background:rgba(200,16,46,.07);animation:missing-pulse 2.5s ease-in-out infinite;}
@keyframes missing-pulse{0%,100%{border-color:rgba(200,16,46,.4)}50%{border-color:rgba(200,16,46,.9);box-shadow:0 0 10px rgba(200,16,46,.3)}}
.dex-missing-label{font-family:'Barlow Condensed',sans-serif;font-size:.75rem;color:rgba(200,16,46,.8);margin-bottom:12px;display:flex;align-items:center;gap:6px;}
.dex-missing-label strong{color:#ff4a4a;}

/* COURT */
#court-view{padding:0;}
.roam-court{position:relative;width:100%;max-width:960px;margin:0 auto;overflow:hidden;border:4px solid var(--gold);}
.roam-court::before{content:'';display:block;padding-top:54%;}
.roam-court svg.floor{position:absolute;inset:0;width:100%;height:100%;z-index:1;}
.roamer-div{position:absolute;transform:translate(-50%,-100%);pointer-events:none;transition:left 4.5s ease-in-out,top 4.5s ease-in-out;display:flex;flex-direction:column;align-items:center;z-index:2;}
.roamer-tag{font-family:'Barlow Condensed',sans-serif;font-size:.6rem;font-weight:700;background:rgba(0,0,0,.75);padding:2px 5px;border-radius:3px;white-space:nowrap;margin-top:3px;}
.roam-court canvas#court-cv{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:3;}
.court-footer{background:var(--navy);padding:10px 16px;max-width:960px;margin:0 auto;border-top:1px solid rgba(249,160,27,.2);}
.court-footer-top{font-family:'Barlow Condensed',sans-serif;font-size:.9rem;color:rgba(245,240,232,.5);text-align:center;margin-bottom:8px;}

/* ROSTER ‚Äî inline edit, stays in place */
.roster-bar{display:flex;align-items:center;justify-content:center;gap:6px;flex-wrap:wrap;}
.roster-slot{
  width:54px;height:54px;border-radius:50%;
  border:2px dashed rgba(249,160,27,.3);background:rgba(0,0,0,.25);
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;color:rgba(245,240,232,.3);font-family:'Barlow Condensed',sans-serif;
  cursor:pointer;transition:border-color .2s,background .2s;position:relative;overflow:hidden;
  flex-shrink:0;
}
.roster-slot.filled{border-color:var(--gold);border-style:solid;border-width:2px;overflow:visible;}
.roster-slot.filled:hover::after{content:'‚úï';position:absolute;inset:0;border-radius:50%;background:rgba(200,16,46,.75);display:flex;align-items:center;justify-content:center;font-size:1rem;color:#fff;}
.roster-slot svg,.roster-slot img{pointer-events:none;}
.roster-hint{font-family:'Barlow Condensed',sans-serif;font-size:.68rem;color:rgba(245,240,232,.28);text-align:center;margin-top:5px;}

/* PLAYER PICKER */
.picker-overlay{display:none;position:fixed;inset:0;background:rgba(0,8,25,.9);z-index:400;align-items:center;justify-content:center;}
.picker-overlay.open{display:flex;}
.picker-modal{background:linear-gradient(160deg,#001830,#002244);border:2px solid var(--teal);border-radius:16px;padding:20px;width:min(500px,96vw);max-height:80vh;overflow-y:auto;}
.picker-title{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:2px;color:var(--teal);margin-bottom:4px;}
.picker-sub{font-family:'Barlow Condensed',sans-serif;font-size:.78rem;color:rgba(245,240,232,.4);margin-bottom:12px;}
.picker-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;}
.picker-item{border:2px solid rgba(255,255,255,.1);border-radius:8px;padding:8px 4px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(0,20,50,.5);}
.picker-item:hover{border-color:var(--teal);background:rgba(0,178,169,.1);}
.picker-item.on-court{border-color:var(--gold);background:rgba(249,160,27,.1);}
.picker-item .pi-char{height:44px;display:flex;align-items:flex-end;justify-content:center;}
.picker-item .pi-name{font-family:'Barlow Condensed',sans-serif;font-size:.62rem;font-weight:700;margin-top:2px;}
.picker-close{float:right;background:none;border:none;color:rgba(255,255,255,.4);font-size:1.4rem;cursor:pointer;}

/* FACES PANEL */
.faces-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:14px;}
.face-slot{background:rgba(0,20,50,.6);border:2px dashed rgba(249,160,27,.25);border-radius:12px;padding:12px 8px;text-align:center;transition:border-color .2s;}
.face-slot:hover{border-color:rgba(249,160,27,.7);}
.face-slot label{cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;}
.face-preview{width:54px;height:54px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:1.5rem;}
.face-preview img{width:100%;height:100%;object-fit:cover;}
.face-pname{font-family:'Barlow Condensed',sans-serif;font-size:.72rem;font-weight:700;color:var(--cream);letter-spacing:.4px;}
.face-sub{font-size:.6rem;color:rgba(245,240,232,.4);}
.face-slot input[type=file]{display:none;}

/* CUSTOM PLAYER */
.custom-creator{background:rgba(0,20,50,.5);border:2px solid rgba(249,160,27,.3);border-radius:16px;padding:24px;max-width:520px;margin:0 auto;}
.custom-preview-area{display:flex;align-items:flex-end;justify-content:center;height:110px;margin-bottom:16px;gap:16px;}
.cp-live-stats{font-family:'Barlow Condensed',sans-serif;font-size:.75rem;color:rgba(245,240,232,.5);display:flex;flex-direction:column;gap:3px;align-self:center;}
.cp-live-stats span{color:var(--gold);}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-grid.wide{grid-template-columns:1fr;}
.form-field{display:flex;flex-direction:column;gap:4px;}
.form-field label{font-family:'Barlow Condensed',sans-serif;font-size:.75rem;font-weight:700;color:rgba(245,240,232,.5);letter-spacing:1px;text-transform:uppercase;}
.form-field input,.form-field select{background:rgba(0,0,0,.4);border:1px solid rgba(249,160,27,.25);border-radius:6px;padding:8px 10px;color:var(--cream);font-family:'Barlow Condensed',sans-serif;font-size:.95rem;width:100%;}
.form-field input:focus,.form-field select:focus{outline:none;border-color:var(--gold);}
.form-field select option{background:#001525;}
.face-upload-btn{display:flex;align-items:center;justify-content:center;gap:8px;background:rgba(0,178,169,.15);border:2px dashed rgba(0,178,169,.4);border-radius:8px;padding:10px;cursor:pointer;font-family:'Barlow Condensed',sans-serif;font-size:.85rem;color:var(--teal);transition:all .2s;width:100%;}
.face-upload-btn:hover{background:rgba(0,178,169,.25);border-color:var(--teal);}
.face-upload-btn input{display:none;}
.save-player-btn{width:100%;background:linear-gradient(135deg,var(--gold),#c87c00);color:var(--navy);border:none;font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:3px;padding:12px;border-radius:8px;cursor:pointer;margin-top:16px;box-shadow:0 4px 18px rgba(249,160,27,.3);transition:transform .1s;}
.save-player-btn:active{transform:scale(.97);}
.saved-badge{text-align:center;font-family:'Barlow Condensed',sans-serif;font-size:.8rem;color:var(--teal);margin-top:8px;display:none;}
.custom-card-display{margin-top:24px;max-width:520px;margin-left:auto;margin-right:auto;}
/* custom player stats section */
.cp-stats-panel{background:rgba(0,0,0,.3);border-radius:10px;padding:12px 16px;margin-top:12px;font-family:'Barlow Condensed',sans-serif;font-size:.82rem;}
.cp-stats-panel h4{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;color:var(--gold);margin-bottom:8px;}
.cp-stat-row{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.05);}
.cp-stat-row:last-child{border-bottom:none;}
.cp-stat-label{color:rgba(245,240,232,.45);}
.cp-stat-val{color:var(--cream);font-weight:600;}

/* SOCIAL STUB */
.social-stub{background:rgba(0,20,50,.5);border:2px solid rgba(124,77,255,.3);border-radius:16px;padding:24px;text-align:center;}
.social-stub h3{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:3px;color:#a87fff;margin-bottom:8px;}
.social-stub p{font-family:'Barlow Condensed',sans-serif;font-size:.9rem;color:rgba(245,240,232,.55);line-height:1.7;margin-bottom:12px;}
.social-stub .coming-soon{display:inline-block;background:rgba(124,77,255,.2);border:1px solid rgba(124,77,255,.4);border-radius:20px;padding:4px 14px;font-family:'Barlow Condensed',sans-serif;font-size:.75rem;letter-spacing:2px;color:#a87fff;margin-bottom:12px;}
.social-feature{background:rgba(0,10,30,.4);border-radius:10px;padding:12px 16px;margin-top:10px;text-align:left;}
.social-feature h4{font-family:'Barlow Condensed',sans-serif;font-size:.9rem;font-weight:700;color:var(--teal);margin-bottom:4px;}
.social-feature p{font-family:'Barlow Condensed',sans-serif;font-size:.8rem;color:rgba(245,240,232,.45);line-height:1.5;}
.social-feature .tech-note{font-size:.72rem;color:rgba(245,240,232,.25);margin-top:4px;font-style:italic;}

/* RARITY BADGES */
.rarity-common{color:var(--common);background:rgba(0,178,169,.15);}
.rarity-rare{color:#a87fff;background:rgba(124,77,255,.15);}
.rarity-epic{color:#ff9940;background:rgba(255,109,0,.15);}
.rarity-legendary{color:var(--gold);background:rgba(249,160,27,.15);}

/* BEAR UNLOCK TOAST */
.bear-toast{position:fixed;top:70px;left:50%;transform:translateX(-50%) translateY(-20px);z-index:500;
  background:linear-gradient(135deg,#8B4513,#5a2a08);
  border:2px solid var(--gold);color:var(--gold);
  font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;
  padding:14px 32px;border-radius:12px;box-shadow:0 4px 40px rgba(249,160,27,.5);
  opacity:0;transition:opacity .4s,transform .4s;pointer-events:none;}
.bear-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<header>
  <div class="logo">Jazz<span>Dex</span></div>
  <div class="hdr-right">
    <div class="hdr-stats">
      <span>CAUGHT <strong id="caught-count">0</strong></span>
      <span>/ <span id="total-count">18</span></span>
    </div>
    <div class="save-badge" id="save-badge">üíæ saved</div>
  </div>
</header>

<nav>
  <button class="nav-btn active"  onclick="showView('map-view',this)">üó∫ Map</button>
  <button class="nav-btn"         onclick="showView('cards-view',this)">üÉè Cards</button>
  <button class="nav-btn"         onclick="showView('dex-view',this)">üìã JazzDex</button>
  <button class="nav-btn"         onclick="showView('court-view',this)">üèü Court</button>
  <button class="nav-btn"         onclick="showView('faces-view',this)">üì∏ Faces</button>
  <button class="nav-btn"         onclick="showView('custom-view',this)">‚≠ê My Player</button>
  <button class="nav-btn"         onclick="showView('social-view',this)">ü§ù Social</button>
</nav>

<!-- MAP -->
<div id="map-view" class="view active">
  <div class="court-wrap" id="court-map">
    <svg class="floor" viewBox="0 0 900 490" xmlns="http://www.w3.org/2000/svg">
      <defs><radialGradient id="fg" cx="50%" cy="50%" r="60%"><stop offset="0%" stop-color="#D4A520"/><stop offset="100%" stop-color="#9A7010"/></radialGradient></defs>
      <rect width="900" height="490" fill="url(#fg)"/>
      <g opacity=".06" stroke="#000" stroke-width="1.5"><line x1="0" y1="40" x2="900" y2="40"/><line x1="0" y1="80" x2="900" y2="80"/><line x1="0" y1="120" x2="900" y2="120"/><line x1="0" y1="160" x2="900" y2="160"/><line x1="0" y1="200" x2="900" y2="200"/><line x1="0" y1="240" x2="900" y2="240"/><line x1="0" y1="280" x2="900" y2="280"/><line x1="0" y1="320" x2="900" y2="320"/><line x1="0" y1="360" x2="900" y2="360"/><line x1="0" y1="400" x2="900" y2="400"/><line x1="0" y1="440" x2="900" y2="440"/></g>
      <rect x="30" y="20" width="840" height="450" fill="none" stroke="rgba(0,43,92,.8)" stroke-width="3" rx="3"/>
      <circle cx="450" cy="245" r="65" fill="rgba(0,43,92,.15)" stroke="rgba(0,43,92,.65)" stroke-width="2.5"/>
      <circle cx="450" cy="245" r="4" fill="rgba(0,43,92,.6)"/>
      <line x1="450" y1="20" x2="450" y2="470" stroke="rgba(0,43,92,.55)" stroke-width="2.5"/>
      <rect x="30" y="158" width="185" height="174" fill="rgba(0,43,92,.2)" stroke="rgba(0,43,92,.65)" stroke-width="2.5"/>
      <rect x="685" y="158" width="185" height="174" fill="rgba(0,43,92,.2)" stroke="rgba(0,43,92,.65)" stroke-width="2.5"/>
      <path d="M30 158 A92 92 0 0 1 215 158" fill="none" stroke="rgba(0,43,92,.65)" stroke-width="2.5"/>
      <path d="M685 158 A92 92 0 0 0 870 158" fill="none" stroke="rgba(0,43,92,.65)" stroke-width="2.5"/>
      <path d="M30 75 Q270 68 270 245 Q270 422 30 415" fill="none" stroke="rgba(0,43,92,.55)" stroke-width="2.5"/>
      <path d="M870 75 Q630 68 630 245 Q630 422 870 415" fill="none" stroke="rgba(0,43,92,.55)" stroke-width="2.5"/>
      <circle cx="68" cy="245" r="17" fill="none" stroke="rgba(0,43,92,.85)" stroke-width="2.5"/>
      <line x1="30" y1="245" x2="85" y2="245" stroke="rgba(0,43,92,.65)" stroke-width="2"/>
      <circle cx="832" cy="245" r="17" fill="none" stroke="rgba(0,43,92,.85)" stroke-width="2.5"/>
      <line x1="815" y1="245" x2="870" y2="245" stroke="rgba(0,43,92,.65)" stroke-width="2"/>
      <text x="450" y="254" text-anchor="middle" font-size="30" font-family="Georgia,serif" font-weight="bold" fill="rgba(0,43,92,.3)" letter-spacing="6">JAZZ</text>
    </svg>
  </div>
  <div class="map-legend">
    <div class="leg-item"><div class="leg-dot" style="background:var(--common)"></div>Common</div>
    <div class="leg-item"><div class="leg-dot" style="background:var(--rare)"></div>Rare</div>
    <div class="leg-item"><div class="leg-dot" style="background:var(--epic)"></div>Epic</div>
    <div class="leg-item"><div class="leg-dot" style="background:var(--legendary)"></div>Legendary</div>
    <span class="map-hint">Players respawn ‚Äî catch multiples!</span>
  </div>
</div>

<!-- CARDS -->
<div id="cards-view" class="view">
  <div class="view-inner">
    <div class="view-title">Player Cards</div>
    <div class="cards-grid" id="cards-grid"></div>
  </div>
</div>

<!-- DEX -->
<div id="dex-view" class="view">
  <div class="view-inner">
    <div class="view-title">JazzDex</div>
    <div class="dex-bar-wrap">
      <div class="dex-track"><div class="dex-fill" id="dex-fill" style="width:0%"></div></div>
      <div class="dex-frac"><span id="dex-n">0</span>/<span id="dex-total">18</span></div>
    </div>
    <div class="dex-grid" id="dex-grid"></div>
  </div>
</div>

<!-- COURT -->
<div id="court-view" class="view">
  <div class="roam-court" id="roam-court">
    <svg class="floor" viewBox="0 0 900 490" xmlns="http://www.w3.org/2000/svg">
      <defs><radialGradient id="fg2" cx="50%" cy="50%" r="60%"><stop offset="0%" stop-color="#D4A520"/><stop offset="100%" stop-color="#9A7010"/></radialGradient></defs>
      <rect width="900" height="490" fill="url(#fg2)"/>
      <g opacity=".06" stroke="#000" stroke-width="1.5"><line x1="0" y1="40" x2="900" y2="40"/><line x1="0" y1="80" x2="900" y2="80"/><line x1="0" y1="120" x2="900" y2="120"/><line x1="0" y1="160" x2="900" y2="160"/><line x1="0" y1="200" x2="900" y2="200"/><line x1="0" y1="240" x2="900" y2="240"/><line x1="0" y1="280" x2="900" y2="280"/><line x1="0" y1="320" x2="900" y2="320"/><line x1="0" y1="360" x2="900" y2="360"/><line x1="0" y1="400" x2="900" y2="400"/><line x1="0" y1="440" x2="900" y2="440"/></g>
      <rect x="30" y="20" width="840" height="450" fill="none" stroke="rgba(0,43,92,.8)" stroke-width="3"/>
      <circle cx="450" cy="245" r="65" fill="rgba(0,43,92,.15)" stroke="rgba(0,43,92,.65)" stroke-width="2.5"/>
      <line x1="450" y1="20" x2="450" y2="470" stroke="rgba(0,43,92,.55)" stroke-width="2.5"/>
      <rect x="30" y="158" width="185" height="174" fill="rgba(0,43,92,.2)" stroke="rgba(0,43,92,.65)" stroke-width="2.5"/>
      <rect x="685" y="158" width="185" height="174" fill="rgba(0,43,92,.2)" stroke="rgba(0,43,92,.65)" stroke-width="2.5"/>
      <circle cx="68" cy="245" r="17" fill="none" stroke="rgba(0,43,92,.85)" stroke-width="2.5"/>
      <circle cx="832" cy="245" r="17" fill="none" stroke="rgba(0,43,92,.85)" stroke-width="2.5"/>
      <text x="450" y="254" text-anchor="middle" font-size="30" font-family="Georgia,serif" font-weight="bold" fill="rgba(0,43,92,.3)" letter-spacing="6">JAZZ</text>
    </svg>
    <canvas id="court-cv"></canvas>
  </div>
  <div class="court-footer">
    <div class="court-footer-top" id="court-footer-top">Catch players to see them roam here!</div>
    <div class="roster-bar" id="roster-bar"></div>
    <div class="roster-hint" id="roster-hint">Tap + to add up to 5 players</div>
  </div>
</div>

<!-- FACES -->
<div id="faces-view" class="view">
  <div class="view-inner">
    <div class="view-title">Upload Player Faces</div>
    <p style="font-family:'Barlow Condensed',sans-serif;font-size:.9rem;color:rgba(245,240,232,.5);margin-bottom:16px;line-height:1.6">Upload a headshot for each player ‚Äî fills their in-game head and card front. Square crops work best.</p>
    <div class="faces-grid" id="faces-grid"></div>
  </div>
</div>

<!-- CUSTOM PLAYER -->
<div id="custom-view" class="view">
  <div class="view-inner">
    <div class="view-title">My Player</div>
    <div class="custom-creator">
      <!-- Live preview area -->
      <div class="custom-preview-area" id="custom-preview-area">
        <div id="custom-preview"></div>
        <div class="cp-live-stats" id="cp-live-stats"></div>
      </div>
      <div class="form-grid">
        <div class="form-field">
          <label>Name</label>
          <input type="text" id="cp-name" placeholder="Your name" maxlength="20">
        </div>
        <div class="form-field">
          <label>Jersey #</label>
          <input type="text" id="cp-num" placeholder="00" maxlength="3">
        </div>
        <div class="form-field">
          <label>PPG</label>
          <input type="number" id="cp-ppg" placeholder="0.0" step="0.1" min="0" max="99">
        </div>
        <div class="form-field">
          <label>APG</label>
          <input type="number" id="cp-apg" placeholder="0.0" step="0.1" min="0" max="99">
        </div>
        <div class="form-field">
          <label>RPG</label>
          <input type="number" id="cp-rpg" placeholder="0.0" step="0.1" min="0" max="99">
        </div>
        <div class="form-field">
          <label>Jersey Color</label>
          <select id="cp-rarity">
            <option value="common">Teal (Common)</option>
            <option value="rare">Purple (Rare)</option>
            <option value="epic">Orange (Epic)</option>
            <option value="legendary">Gold (Legendary)</option>
          </select>
        </div>
      </div>
      <div class="form-grid wide" style="margin-top:12px">
        <div class="form-field">
          <label>Quote / Motto</label>
          <input type="text" id="cp-quote" placeholder="Your catchphrase..." maxlength="60">
        </div>
      </div>
      <label class="face-upload-btn" style="margin-top:12px">
        üì∑ Upload Your Face Photo
        <input type="file" accept="image/*" id="cp-face-input" onchange="loadCustomFace(this)">
      </label>
      <button class="save-player-btn" onclick="saveCustomPlayer()">üíæ SAVE MY PLAYER</button>
      <div class="saved-badge" id="cp-saved">‚úì Player saved!</div>
    </div>
    <!-- Stats panel shown after save -->
    <div id="cp-stats-section"></div>
    <!-- Card preview shown after save -->
    <div class="custom-card-display" id="custom-card-display"></div>
  </div>
</div>

<!-- SOCIAL -->
<div id="social-view" class="view">
  <div class="view-inner">
    <div class="view-title">Social</div>
    <div class="social-stub">
      <span class="coming-soon">COMING SOON</span>
      <h3>Connect with Friends</h3>
      <p>These features are planned and ready to build ‚Äî they need a backend server to go live. Here's what's coming:</p>
      <div class="social-feature">
        <h4>üîê Sign In / Accounts</h4>
        <p>Create an account to save your progress across devices, build your custom player, and connect with friends.</p>
        <p class="tech-note">Tech: Firebase Auth or Supabase ‚Üí free tier handles thousands of users</p>
      </div>
      <div class="social-feature">
        <h4>üë• Find Other Users</h4>
        <p>Search by username, see their JazzDex completion, and send friend requests.</p>
        <p class="tech-note">Tech: Firestore user collection + friend-request subcollection</p>
      </div>
      <div class="social-feature">
        <h4>üîÑ Trade Cards & Custom Players</h4>
        <p>Offer duplicates from your collection to friends. Both parties confirm before cards swap. Custom players can be shared too.</p>
        <p class="tech-note">Tech: Atomic Firestore transaction ‚Äî both card counts update simultaneously</p>
      </div>
      <div class="social-feature">
        <h4>üìä Friend Stats</h4>
        <p>See when you became friends, time each of you has played, last active, and head-to-head completion.</p>
        <p class="tech-note">Tech: User profile doc with sessionTime, lastSeen, friendedAt timestamps</p>
      </div>
      <div class="social-feature" style="border-left:3px solid #00B2A9;margin-top:16px;">
        <h4>üóÑÔ∏è Seagate Lyve Cloud ‚Äî Recommended Storage Backend</h4>
        <p>Seagate Lyve Cloud is an S3-compatible object storage service ‚Äî great for storing player card images, face uploads, and exported game state files. Since JazzDex already stores face photos as base64 data URLs, Lyve Cloud can offload that weight so saves stay fast even with a full roster of faces uploaded.</p>
        <p style="margin-top:6px">How it fits in:</p>
        <p>‚Ä¢ <strong style="color:var(--teal)">Face photos</strong> ‚Üí upload to a Lyve bucket, store the URL instead of the base64 blob in localStorage</p>
        <p>‚Ä¢ <strong style="color:var(--teal)">Game state exports</strong> ‚Üí save each user's JSON snapshot to Lyve for cross-device restore</p>
        <p>‚Ä¢ <strong style="color:var(--teal)">Card trades</strong> ‚Üí both users' state files swap atomically via a small API layer in front of Lyve</p>
        <p class="tech-note">Lyve Cloud uses standard S3 API calls ‚Äî any S3 SDK works. Pair with a thin auth layer (Cloudflare Workers or a small Node server) to gate access per user. Lyve's free tier handles early traffic well.</p>
      </div>
      <p style="margin-top:16px;font-size:.78rem;color:rgba(245,240,232,.3)">
        All the data shapes are already stubbed in the JS ‚Äî when the backend is ready, it's mostly a matter of swapping localStorage calls for fetch() calls to your Lyve-backed API.
      </p>
    </div>
  </div>
</div>

<!-- CATCH MODAL -->
<div class="modal-overlay" id="catch-modal">
  <div class="catch-modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div id="modal-body"></div>
  </div>
</div>

<!-- PLAYER PICKER -->
<div class="picker-overlay" id="picker-overlay">
  <div class="picker-modal">
    <button class="picker-close" onclick="closePicker()">‚úï</button>
    <div class="picker-title">Choose a Player</div>
    <div class="picker-sub">Tap to add or remove from court slot</div>
    <div class="picker-grid" id="picker-grid"></div>
  </div>
</div>

<!-- BEAR TOAST -->
<div class="bear-toast" id="bear-toast">üêª JAZZ BEAR UNLOCKED!</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RARITY / SHIRT COLORS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const RARITY_COLORS = {common:'#00B2A9',rare:'#7C4DFF',epic:'#FF6D00',legendary:'#F9A01B'};
const SHIRT_COLORS  = {common:'#00868a',rare:'#5533aa',epic:'#aa3300',legendary:'#aa7700'};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SPAWN CONFIG
   interval = ms between spawn cycles
   duration = ms each player is visible
   MAX_SPAWNS = total on-map limit at once
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const RARITY_SPAWN = {
  common:   {interval:7000, duration:18000},
  rare:     {interval:13000,duration:9000},
  epic:     {interval:22000,duration:6000},
  legendary:{interval:40000,duration:3500},
};
const MAX_SPAWNS = 5; // ‚ñ∂ change to limit simultaneous on-map characters

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PLAYERS ‚Äî rarity order: legendary ‚Üí epic ‚Üí rare ‚Üí common
   lastName used for sort within rarity
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const PLAYERS = [
  // LEGENDARY
  {id:1, name:'Karl Malone',      short:'Malone',   rarity:'legendary',lastName:'Malone',   era:'1985‚Äì2003',ppg:25.0,apg:3.6, rpg:10.1,blk:1.0, quote:'The Mailman always delivers.',     num:'32'},
  {id:2, name:'John Stockton',    short:'Stockton', rarity:'legendary',lastName:'Stockton', era:'1984‚Äì2003',ppg:13.1,apg:10.5,rpg:2.7, blk:0.2, quote:'Greatest PG of all time.',         num:'12'},
  // EPIC
  {id:3, name:'Pete Maravich',    short:'Pistol',   rarity:'epic',     lastName:'Maravich', era:'1974‚Äì1980',ppg:24.4,apg:5.4, rpg:4.2, blk:0.2, quote:'Pistol Pete ‚Äî pure magic.',        num:'7'},
  {id:4, name:'Donovan Mitchell', short:'Spida',    rarity:'epic',     lastName:'Mitchell', era:'2017‚Äì2021',ppg:23.9,apg:4.4, rpg:4.4, blk:0.5, quote:'Spida climbs any wall.',           num:'45'},
  {id:5, name:'Adrian Dantley',   short:'Dantley',  rarity:'epic',     lastName:'Dantley',  era:'1979‚Äì1986',ppg:26.6,apg:2.9, rpg:5.7, blk:0.3, quote:'A scoring machine.',               num:'4'},
  // RARE
  {id:6, name:'Rudy Gobert',      short:'Gobert',   rarity:'rare',     lastName:'Gobert',   era:'2013‚Äì2022',ppg:14.3,apg:1.3, rpg:13.5,blk:2.3, quote:'The Stifle Tower.',                num:'27'},
  {id:7, name:'Darrell Griffith', short:'Griff',    rarity:'rare',     lastName:'Griffith', era:'1980‚Äì1991',ppg:16.2,apg:2.2, rpg:3.6, blk:0.5, quote:'Dr. Dunkenstein takes flight.',    num:'35'},
  {id:8, name:'Andrei Kirilenko', short:'AK-47',    rarity:'rare',     lastName:'Kirilenko',era:'2001‚Äì2011',ppg:12.2,apg:3.2, rpg:6.4, blk:2.2, quote:'AK-47 ‚Äî one of a kind.',           num:'47'},
  {id:9, name:'Mehmet Okur',      short:'Okur',     rarity:'rare',     lastName:'Okur',     era:'2004‚Äì2011',ppg:14.6,apg:1.8, rpg:7.3, blk:1.2, quote:'The Turkish Hammer.',              num:'13'},
  {id:10,name:'Deron Williams',   short:'D-Will',   rarity:'rare',     lastName:'Williams', era:'2005‚Äì2011',ppg:18.8,apg:9.3, rpg:3.7, blk:0.3, quote:'D-Will was something special.',    num:'8'},
  {id:11,name:'Mark Eaton',       short:'Eaton',    rarity:'rare',     lastName:'Eaton',    era:'1982‚Äì1993',ppg:6.0, apg:0.6, rpg:7.9, blk:3.5, quote:'No easy buckets.',                 num:'53'},
  {id:12,name:'Thurl Bailey',     short:'T.Bailey', rarity:'rare',     lastName:'Bailey',   era:'1983‚Äì1991',ppg:13.3,apg:1.3, rpg:6.1, blk:1.6, quote:'Big T ‚Äî heart of gold.',           num:'41'},
  // COMMON
  {id:13,name:'Bojan Bogdanovic', short:'Bojan',    rarity:'common',   lastName:'Bogdanovic',era:'2019‚Äì2022',ppg:18.2,apg:2.1,rpg:3.7, blk:0.2, quote:'Automatic from corner.',           num:'44'},
  {id:14,name:'Carlos Boozer',    short:'Boozer',   rarity:'common',   lastName:'Boozer',   era:'2004‚Äì2010',ppg:16.5,apg:1.8, rpg:9.6, blk:0.6, quote:'Power and finesse combined.',      num:'5'},
  {id:15,name:'Jordan Clarkson',  short:'Clarkson', rarity:'common',   lastName:'Clarkson', era:'2019‚ÄìNow', ppg:17.4,apg:2.5, rpg:3.3, blk:0.2, quote:'Sixth Man energy.',               num:'00'},
  {id:16,name:'Jeff Hornacek',    short:'Hornacek', rarity:'common',   lastName:'Hornacek', era:'1994‚Äì2000',ppg:16.6,apg:4.7, rpg:3.3, blk:0.2, quote:"A clutch shooter's shooter.",     num:'14'},
  {id:17,name:'Joe Ingles',       short:'Ingles',   rarity:'common',   lastName:'Ingles',   era:'2014‚Äì2022',ppg:8.5, apg:3.3, rpg:3.1, blk:0.3, quote:'Aussie wit & threes.',             num:'2'},
  {id:18,name:'Kyle Korver',      short:'Korver',   rarity:'common',   lastName:'Korver',   era:'2007‚Äì2010',ppg:11.5,apg:1.5, rpg:3.0, blk:0.2, quote:'The most dangerous shooter alive.',num:'26'},
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BEAR ‚Äî secret, only after catching all 18
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const BEAR = {
  id:999, name:'Jazz Bear', short:'Bear', rarity:'legendary', lastName:'Bear',
  era:'1994‚ÄìNow', ppg:0, apg:0, rpg:0, blk:999,
  quote:'The heart and soul of Delta Center.', num:'üêª', isBear:true,
};

/* Sort helper: legendary > epic > rare > common, then lastName A‚ÜíZ */
const RARITY_ORDER = {legendary:0,epic:1,rare:2,common:3};
function sortedPlayers(list) {
  return [...list].sort((a,b)=>{
    const rd = RARITY_ORDER[a.rarity] - RARITY_ORDER[b.rarity];
    return rd !== 0 ? rd : (a.lastName||a.name).localeCompare(b.lastName||b.name);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let caught       = new Set();
let cardCounts   = {};
let faceImages   = {};
let activeSpawns = {};
let roamPos      = {};
let roamTimer    = null;
let courtAF      = null;
let currentTarget= null;
let hoopAF       = null;
let courtRoster  = [];       // array of player ids (max 5)
let bearUnlocked = false;
let customPlayer = null;
let customFaceImg= null;
// Custom player session tracking
let sessionStart = Date.now();
let totalPlayMs  = 0;
let lastSeen     = null;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOCAL STORAGE
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function saveState() {
  try {
    totalPlayMs += Date.now() - sessionStart;
    sessionStart = Date.now();
    localStorage.setItem('jd_caught',    JSON.stringify([...caught]));
    localStorage.setItem('jd_counts',   JSON.stringify(cardCounts));
    localStorage.setItem('jd_faces',    JSON.stringify(faceImages));
    localStorage.setItem('jd_roster',   JSON.stringify(courtRoster));
    localStorage.setItem('jd_bear',     bearUnlocked?'1':'0');
    localStorage.setItem('jd_custom',   JSON.stringify(customPlayer));
    localStorage.setItem('jd_cface',    customFaceImg||'');
    localStorage.setItem('jd_roampos',  JSON.stringify(roamPos));
    localStorage.setItem('jd_playtime', totalPlayMs.toString());
    localStorage.setItem('jd_lastseen', new Date().toISOString());
    flashSave();
  } catch(e){}
}

function loadState() {
  try {
    const c  = localStorage.getItem('jd_caught');
    const cc = localStorage.getItem('jd_counts');
    const f  = localStorage.getItem('jd_faces');
    const r  = localStorage.getItem('jd_roster');
    const b  = localStorage.getItem('jd_bear');
    const cp = localStorage.getItem('jd_custom');
    const cf = localStorage.getItem('jd_cface');
    const rp = localStorage.getItem('jd_roampos');
    const pt = localStorage.getItem('jd_playtime');
    const ls = localStorage.getItem('jd_lastseen');
    if (c)  caught = new Set(JSON.parse(c));
    if (cc) cardCounts = JSON.parse(cc);
    if (f)  faceImages = JSON.parse(f);
    if (r)  { const parsed = JSON.parse(r); courtRoster = parsed.filter(id=>id==='cp'||id===999||caught.has(id)); }
    if (b)  bearUnlocked = b==='1';
    if (cp) customPlayer = JSON.parse(cp);
    if (cf) customFaceImg = cf||null;
    if (rp) roamPos = JSON.parse(rp);
    if (pt) totalPlayMs = parseInt(pt)||0;
    if (ls) lastSeen = ls;
  } catch(e){}
}

function flashSave() {
  const b = document.getElementById('save-badge');
  if (!b) return;
  b.style.opacity='1'; b.textContent='üíæ saved';
  setTimeout(()=>b.style.opacity='0', 2000);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHARACTER SVG BUILDER
   ‚ñ∂ Edit SVG below to change body shape
   ‚ñ∂ Edit bobDur to change animation speed
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildChar(p, size=56) {
  const shirt   = SHIRT_COLORS[p.rarity]||'#00868a';
  const glow    = RARITY_COLORS[p.rarity]||'#00B2A9';
  const rawId   = p.id; // stable unique id for clipPath
  const face    = p.isBear ? null : (p.isCustom ? customFaceImg : faceImages[p.id]||null);
  const bobDur  = (1.4+(String(p.id).charCodeAt(0)%5)*0.18)+'s';
  const headFill= face ? 'transparent' : (p.isBear?'#8B4513':'#dfc090');

  const bearFace = p.isBear ? `
    <circle cx="17" cy="7"  r="5" fill="#6B3410"/><circle cx="39" cy="7"  r="5" fill="#6B3410"/>
    <circle cx="17" cy="7"  r="3" fill="#8B4513"/><circle cx="39" cy="7"  r="3" fill="#8B4513"/>
    <ellipse cx="28" cy="22" rx="7" ry="5" fill="#c8956a"/>
    <ellipse cx="28" cy="19" rx="3" ry="2" fill="#1a0a00"/>
    <circle cx="23" cy="15" r="2.5" fill="#1a0a00"/><circle cx="33" cy="15" r="2.5" fill="#1a0a00"/>
    <circle cx="23.7" cy="14.2" r=".8" fill="white"/><circle cx="33.7" cy="14.2" r=".8" fill="white"/>
    <path d="M24 23 Q28 27 32 23" stroke="#5a2a10" stroke-width="1.2" fill="none" stroke-linecap="round"/>` : '';

  const faceEl = face
    ? `<image href="${face}" x="13" y="3" width="30" height="30" clip-path="url(#hc${rawId})"/>`
    : (p.isBear ? bearFace : '');

  return `<svg width="${size}" height="${Math.round(size*1.07)}" viewBox="0 0 56 60" xmlns="http://www.w3.org/2000/svg" style="overflow:visible;display:block">
  <defs><clipPath id="hc${rawId}"><circle cx="28" cy="18" r="15"/></clipPath></defs>
  <g style="animation:chbob${rawId} ${bobDur} ease-in-out infinite">
    <style>@keyframes chbob${rawId}{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}</style>
    <ellipse cx="20" cy="59" rx="7" ry="2.8" fill="#111"/>
    <ellipse cx="36" cy="59" rx="7" ry="2.8" fill="#111"/>
    <rect x="16" y="46" width="9" height="14" rx="4" fill="${shirt}" opacity=".85"/>
    <rect x="31" y="46" width="9" height="14" rx="4" fill="${shirt}" opacity=".85"/>
    <rect x="13" y="29" width="30" height="20" rx="7" fill="${shirt}"/>
    <text x="28" y="43" text-anchor="middle" font-size="${p.isBear?9:7}" font-family="Arial Black,sans-serif" font-weight="900" fill="rgba(255,255,255,.88)">${p.num}</text>
    <rect x="4"  y="30" width="11" height="7" rx="3.5" fill="${shirt}" opacity=".9"/>
    <rect x="41" y="30" width="11" height="7" rx="3.5" fill="${shirt}" opacity=".9"/>
    <rect x="24" y="26" width="8" height="6" rx="3" fill="${headFill}"/>
    <g style="animation:hdsway${rawId} ${bobDur} ease-in-out infinite;transform-origin:28px 18px">
      <style>@keyframes hdsway${rawId}{0%,100%{transform:rotate(-2.5deg)}50%{transform:rotate(2.5deg)}}</style>
      <circle cx="28" cy="18" r="15" fill="${headFill}"/>
      ${faceEl}
      <circle cx="28" cy="18" r="15" fill="none" stroke="rgba(0,0,0,.12)" stroke-width="1"/>
      ${!p.isBear?`<path d="M13 11 Q28 2 43 11" fill="${shirt}" opacity=".55"/>`:''}
    </g>
    ${p.rarity==='legendary'?`<text x="47" y="7" font-size="8" fill="${glow}">‚òÖ</text>`:''}
    ${p.rarity==='epic'?`<text x="47" y="7" font-size="7" fill="${glow}">‚óÜ</text>`:''}
  </g>
</svg>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FACES PANEL
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderFaces() {
  const grid = document.getElementById('faces-grid');
  if (!grid) return;
  grid.innerHTML = PLAYERS.map(p => {
    const col = RARITY_COLORS[p.rarity];
    const has = !!faceImages[p.id];
    return `<div class="face-slot" style="border-color:${col}55">
      <label>
        <div class="face-preview" id="fp-${p.id}">${has?`<img src="${faceImages[p.id]}"/>`:'üì∑'}</div>
        <div class="face-pname">${p.short}</div>
        <div class="face-sub" style="color:${col}">${p.rarity}</div>
        <input type="file" accept="image/*" onchange="loadFace(${p.id},this)">
      </label>
    </div>`;
  }).join('');
}

function loadFace(id, input) {
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    faceImages[id]=e.target.result;
    const prev=document.getElementById('fp-'+id);
    if(prev) prev.innerHTML=`<img src="${e.target.result}"/>`;
    saveState();
    if(document.getElementById('cards-view').classList.contains('active')) renderCards();
    if(document.getElementById('dex-view').classList.contains('active'))   renderDex();
    if(document.getElementById('court-view').classList.contains('active')) rebuildRoamers();
    const mc=document.getElementById('modal-char');
    if(mc&&currentTarget&&currentTarget.id===id) mc.innerHTML=buildChar(currentTarget,68);
    const sb=document.querySelector(`.spawn-char[data-id="${id}"] .char-body`);
    if(sb) sb.innerHTML=buildChar(PLAYERS.find(pl=>pl.id===id),50);
  };
  reader.readAsDataURL(file);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CUSTOM PLAYER
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function loadCustomFace(input) {
  const file=input.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{ customFaceImg=e.target.result; refreshCustomPreview(); };
  reader.readAsDataURL(file);
}

function getCustomFakePlayer() {
  const name   = document.getElementById('cp-name')?.value||'My Player';
  const num    = document.getElementById('cp-num')?.value||'00';
  const rarity = document.getElementById('cp-rarity')?.value||'common';
  return {id:'cp',name,short:name.split(' ')[0]||name,rarity,num,isCustom:true};
}

function refreshCustomPreview() {
  const preview = document.getElementById('custom-preview');
  if (!preview) return;
  const fake = getCustomFakePlayer();
  preview.innerHTML = buildChar(fake, 80);
  // Live stat display
  const ppg = document.getElementById('cp-ppg')?.value||'‚Äî';
  const apg = document.getElementById('cp-apg')?.value||'‚Äî';
  const rpg = document.getElementById('cp-rpg')?.value||'‚Äî';
  const ls  = document.getElementById('cp-live-stats');
  if (ls) ls.innerHTML = `<div>PPG <span>${ppg}</span></div><div>APG <span>${apg}</span></div><div>RPG <span>${rpg}</span></div>`;
}

function saveCustomPlayer() {
  const name  = document.getElementById('cp-name')?.value?.trim()||'My Player';
  const num   = document.getElementById('cp-num')?.value?.trim()||'00';
  const ppg   = parseFloat(document.getElementById('cp-ppg')?.value)||0;
  const apg   = parseFloat(document.getElementById('cp-apg')?.value)||0;
  const rpg   = parseFloat(document.getElementById('cp-rpg')?.value)||0;
  const rarity= document.getElementById('cp-rarity')?.value||'common';
  const quote = document.getElementById('cp-quote')?.value?.trim()||'Built different.';
  const now   = new Date();

  customPlayer = {
    id:'cp', name, short:name.split(' ')[0]||name, rarity,
    era:`${now.getFullYear()}‚ÄìNow`, lastName:name.split(' ').pop(),
    ppg, apg, rpg, blk:0, quote, num, isCustom:true,
    joinedISO: now.toISOString(),
    joinedDisplay: fmtDateNice(now.toISOString()),
  };

  saveState();
  const badge=document.getElementById('cp-saved');
  if(badge){badge.style.display='block'; setTimeout(()=>badge.style.display='none',2500);}
  renderCustomCard();
  renderCustomStats();
}

function fmtDuration(ms) {
  const h = Math.floor(ms/3600000);
  const m = Math.floor((ms%3600000)/60000);
  if (h>0) return `${h}h ${m}m`;
  return `${m}m`;
}

function fmtDateNice(iso) {
  if(!iso) return '‚Äî';
  const d = new Date(iso);
  const day = d.getDate();
  const suffix = day===1||day===21||day===31?'st':day===2||day===22?'nd':day===3||day===23?'rd':'th';
  return d.toLocaleDateString('en-US',{month:'long',year:'numeric'}).replace(',',` ${day}${suffix},`);
}

function renderCustomStats() {
  const sec = document.getElementById('cp-stats-section');
  if (!sec||!customPlayer) { if(sec) sec.innerHTML=''; return; }
  const playtime = fmtDuration(totalPlayMs+(Date.now()-sessionStart));
  const lsDisplay = lastSeen ? fmtDateNice(lastSeen) : 'This session';
  const joinedDisplay = customPlayer.joinedISO ? fmtDateNice(customPlayer.joinedISO) : (customPlayer.joinedDisplay||'‚Äî');
  sec.innerHTML = `<div class="cp-stats-panel" style="max-width:520px;margin:16px auto 0">
    <h4>üìä My Player Stats</h4>
    <div class="cp-stat-row"><span class="cp-stat-label">Joined</span><span class="cp-stat-val">${joinedDisplay}</span></div>
    <div class="cp-stat-row"><span class="cp-stat-label">Time Played</span><span class="cp-stat-val">${playtime}</span></div>
    <div class="cp-stat-row"><span class="cp-stat-label">Last Active</span><span class="cp-stat-val">${lsDisplay}</span></div>
    <div class="cp-stat-row"><span class="cp-stat-label">Cards Caught</span><span class="cp-stat-val">${caught.size}</span></div>
    <div class="cp-stat-row"><span class="cp-stat-label">When Traded</span><span class="cp-stat-val" style="color:rgba(245,240,232,.3);font-style:italic">Coming with Social features</span></div>
    <div class="cp-stat-row"><span class="cp-stat-label">Friends Since</span><span class="cp-stat-val" style="color:rgba(245,240,232,.3);font-style:italic">Coming with Social features</span></div>
  </div>`;
}

function buildCardHTML(p, count) {
  const face = p.isCustom ? customFaceImg : faceImages[p.id];
  const frontFace = face
    ? `<div class="card-face card-front">
         <img class="card-front-img" src="${face}" alt="${p.name}"/>
         <div class="card-jersey-badge">#${p.num}</div>
         <div class="card-front-overlay">
           <div class="card-pname">${p.name}</div>
           <span class="card-rbadge rarity-${p.rarity}">${p.rarity}</span>
         </div>
       </div>`
    : `<div class="card-face card-front">
         <div class="card-front-noimg">
           <div class="card-char">${buildChar(p,70)}</div>
           <div class="card-pname">${p.name}</div>
           <div class="card-era">${p.era}</div>
           <span class="card-rbadge rarity-${p.rarity}" style="margin-top:2px">${p.rarity}</span>
         </div>
         <div class="card-jersey-badge">#${p.num}</div>
       </div>`;

  const customDateRow = p.isCustom&&p.joinedDisplay
    ? `<div class="srow"><span class="sl">Joined</span><span class="sv" style="font-size:.72rem">${p.joinedDisplay}</span></div>`
    : '';

  return `<div class="card-flip-wrap" data-r="${p.rarity}" onclick="this.classList.toggle('flipped')">
    <div class="card-count-badge">√ó${count}</div>
    <div class="card-inner">
      ${frontFace}
      <div class="card-face card-back">
        <div class="card-back-inner">
          <div class="card-back-num">#${String(p.id).padStart(3,'0')} ¬∑ ${p.rarity.toUpperCase()}</div>
          <div class="card-back-name">${p.name}</div>
          <div class="card-back-era">${p.era}</div>
          <div class="card-back-stats">
            <div class="srow"><span class="sl">PPG</span><span class="sv">${p.ppg}</span></div>
            <div class="srow"><span class="sl">APG</span><span class="sv">${p.apg}</span></div>
            <div class="srow"><span class="sl">RPG</span><span class="sv">${p.rpg}</span></div>
            <div class="srow"><span class="sl">BLK</span><span class="sv">${p.blk}</span></div>
            ${customDateRow}
          </div>
          <div class="card-back-quote">"${p.quote}"</div>
          <div class="card-back-hint">tap to flip back</div>
        </div>
      </div>
    </div>
  </div>`;
}

function renderCustomCard() {
  const area = document.getElementById('custom-card-display');
  if(!area||!customPlayer){if(area)area.innerHTML='';return;}
  const count = cardCounts['cp']||1;
  area.innerHTML = `
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:.78rem;color:rgba(245,240,232,.35);text-align:center;margin:12px 0 8px;letter-spacing:1px">YOUR CARD ‚Äî tap to flip</div>
    <div class="cards-grid" style="max-width:220px;margin:0 auto">${buildCardHTML(customPlayer,count)}</div>`;
}

function initCustomView() {
  if(customPlayer) {
    document.getElementById('cp-name').value   = customPlayer.name||'';
    document.getElementById('cp-num').value    = customPlayer.num||'';
    document.getElementById('cp-ppg').value    = customPlayer.ppg||'';
    document.getElementById('cp-apg').value    = customPlayer.apg||'';
    document.getElementById('cp-rpg').value    = customPlayer.rpg||'';
    document.getElementById('cp-rarity').value = customPlayer.rarity||'common';
    document.getElementById('cp-quote').value  = customPlayer.quote||'';
  }
  refreshCustomPreview();
  renderCustomCard();
  renderCustomStats();
  ['cp-name','cp-num','cp-rarity','cp-ppg','cp-apg','cp-rpg'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.addEventListener('input',refreshCustomPreview);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   JAZZ BEAR ‚Äî fully secret, no nav tab
   After catching all 18, Bear unlocks:
   - shows toast
   - starts spawning on map
   - appears in cards, dex, court picker
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function checkBearUnlock() {
  if (bearUnlocked) return;
  const allCaught = PLAYERS.every(p=>caught.has(p.id));
  if (!allCaught) return;
  bearUnlocked = true;
  caught.add(999);
  cardCounts[999] = 1;
  saveState();
  showBearToast();
  scheduleBear();
}

function showBearToast() {
  const t = document.getElementById('bear-toast');
  if(!t) return;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 4500);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SPAWN SYSTEM
   Global cap = MAX_SPAWNS across all players.
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function totalActiveSpawns() {
  return Object.keys(activeSpawns).length;
}

function scheduleAll() {
  PLAYERS.forEach(p=>{
    const delay = Math.random() * RARITY_SPAWN[p.rarity].interval * 0.7;
    setTimeout(()=>spawnLoop(p), delay);
  });
}

function scheduleBear() {
  spawnLoop(BEAR);
}

function spawnLoop(p) {
  if (!activeSpawns[p.id]) trySpawn(p);
  const cfg = p.isBear ? RARITY_SPAWN.legendary : RARITY_SPAWN[p.rarity];
  const nextIn = cfg.interval*(0.8+Math.random()*0.6);
  setTimeout(()=>spawnLoop(p), cfg.duration+nextIn);
}

function trySpawn(p) {
  // Bear only spawns if unlocked
  if (p.isBear && !bearUnlocked) return;
  // Global spawn cap
  if (totalActiveSpawns() >= MAX_SPAWNS) return;
  if (activeSpawns[p.id]) return;

  const cfg  = p.isBear ? RARITY_SPAWN.legendary : RARITY_SPAWN[p.rarity];
  const glow = RARITY_COLORS[p.rarity];
  const court= document.getElementById('court-map');
  let x = 12+Math.random()*76;
  let y = 14+Math.random()*72;

  const wrap = document.createElement('div');
  wrap.className='spawn-char';
  wrap.dataset.id=p.id;
  wrap.style.cssText=`left:${x}%;top:${y}%;filter:drop-shadow(0 0 ${p.rarity==='legendary'?'12':'6'}px ${glow})`;

  const body=document.createElement('div'); body.className='char-body';
  body.innerHTML=buildChar(p,50);
  const shadow=document.createElement('div'); shadow.className='char-shadow';
  const tag=document.createElement('div'); tag.className='char-tag';
  tag.style.color=glow;
  tag.textContent=p.isBear?'???' : p.short; // Bear shows ??? as a tease before catch

  body.appendChild(shadow); wrap.appendChild(body); wrap.appendChild(tag);
  court.appendChild(wrap);
  requestAnimationFrame(()=>wrap.classList.add('popin'));
  wrap.addEventListener('click',()=>openCatch(p.id, p.isBear));

  const roamId=setInterval(()=>{
    if(!activeSpawns[p.id]) return;
    x=Math.max(8,Math.min(92,x+(Math.random()-.5)*10));
    y=Math.max(10,Math.min(88,y+(Math.random()-.5)*10));
    wrap.style.left=x+'%'; wrap.style.top=y+'%';
  },3200);

  const despawnId=setTimeout(()=>doDeSpawn(p.id),cfg.duration);
  activeSpawns[p.id]={el:wrap,roamId,despawnId};
}

function doDeSpawn(id) {
  const s=activeSpawns[id]; if(!s) return;
  clearInterval(s.roamId); clearTimeout(s.despawnId);
  s.el.classList.add('popout');
  setTimeout(()=>s.el.remove(),350);
  delete activeSpawns[id];
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CATCH MODAL ‚Äî 3 shots, auto-catch on make
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openCatch(id, isBear=false) {
  currentTarget = isBear ? BEAR : PLAYERS.find(p=>p.id===id);
  const p = currentTarget;
  const pips=[0,1,2].map(i=>`<div class="shot-pip pending" id="sp${i}">üèÄ</div>`).join('');
  document.getElementById('modal-body').innerHTML=`
    <div class="modal-header">
      <div class="modal-char" id="modal-char">${buildChar(p,68)}</div>
      <div class="modal-info">
        <div class="modal-name">${p.isBear?'???':p.name}</div>
        <span class="modal-rbadge rarity-${p.rarity}">${p.isBear?'MYSTERY':p.rarity.toUpperCase()}</span>
      </div>
    </div>
    <div class="hoop-section">
      <div class="hoop-title">MAKE A BASKET ‚Äî 3 chances, first make catches!</div>
      <div class="shot-row">${pips}</div>
      <canvas id="hoop-cv" width="380" height="150"></canvas>
      <button class="throw-btn" id="throw-btn" onclick="doThrow()">üèÄ THROW</button>
    </div>
    <div class="fail-msg" id="fail-msg">üòì All 3 missed ‚Äî they got away!</div>
    <div class="success-screen" id="success-screen">
      <span class="burst">${p.isBear?'üêª':'üéâ'}</span>
      <h3>${p.isBear?'JAZZ BEAR!':'CAUGHT!'}</h3>
      <p>${p.isBear?'The legend himself is in your JazzDex!':p.name+' added to your JazzDex!'}</p>
    </div>`;
  document.getElementById('catch-modal').classList.add('open');
  initHoop();
}

function initHoop() {
  const canvas=document.getElementById('hoop-cv'); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height;
  const hoopX=W*.75,hoopY=H*.30,rimR=20;
  const ballX=W*.14,ballY=H*.84;
  const sweetW=22; // ‚ñ∂ tolerance ‚Äî bigger = easier
  const AIM_SPEEDS={common:.016,rare:.026,epic:.036,legendary:.050};
  const speed=AIM_SPEEDS[currentTarget?.rarity]||.025;
  let aimAngle=0,phase='aim',flyT=0,flyScatter=0,swish=0,shotsDone=0;

  function scatter(){return Math.sin(aimAngle)*58;}
  function arcPt(t,sc){
    const tx=hoopX+sc,cpX=(ballX+tx)*.5,cpY=Math.min(ballY,hoopY)-H*.55;
    return{bx:(1-t)*(1-t)*ballX+2*(1-t)*t*cpX+t*t*tx,by:(1-t)*(1-t)*ballY+2*(1-t)*t*cpY+t*t*hoopY};
  }
  function drawBall(x,y,r=11){
    const g=ctx.createRadialGradient(x-r*.35,y-r*.35,r*.1,x,y,r);
    g.addColorStop(0,'#ffb347');g.addColorStop(1,'#c84800');
    ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.3)';ctx.lineWidth=1.2;
    ctx.beginPath();ctx.arc(x,y,r,-.5,.5);ctx.stroke();
    ctx.beginPath();ctx.arc(x,y,r,Math.PI-.5,Math.PI+.5);ctx.stroke();
  }
  function drawHoop(){
    ctx.fillStyle='#e0d8c0';ctx.fillRect(hoopX+rimR+3,hoopY-28,7,50);
    ctx.strokeStyle='#bbb';ctx.lineWidth=1;ctx.strokeRect(hoopX+rimR+3,hoopY-28,7,50);
    ctx.strokeStyle='rgba(255,255,255,.4)';ctx.lineWidth=1;
    for(let i=0;i<=4;i++){const nx=hoopX-rimR+(rimR*2/4)*i;ctx.beginPath();ctx.moveTo(nx,hoopY+4);ctx.lineTo(hoopX+(nx-hoopX)*.4,hoopY+26);ctx.stroke();}
    ctx.beginPath();ctx.moveTo(hoopX-rimR*.5,hoopY+26);ctx.lineTo(hoopX+rimR*.5,hoopY+26);ctx.stroke();
    ctx.strokeStyle='#E05500';ctx.lineWidth=4.5;
    ctx.beginPath();ctx.ellipse(hoopX,hoopY,rimR,5,0,0,Math.PI*2);ctx.stroke();
  }
  function frame(){
    ctx.clearRect(0,0,W,H);drawHoop();
    if(swish>0){ctx.globalAlpha=swish*.45;ctx.fillStyle='#F9A01B';ctx.beginPath();ctx.arc(hoopX,hoopY,rimR+16,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;swish=Math.max(0,swish-.06);}
    if(phase==='aim'){
      aimAngle+=speed;
      const sc=scatter(),inZone=Math.abs(sc)<sweetW;
      ctx.save();ctx.setLineDash([5,5]);
      ctx.strokeStyle=inZone?'rgba(249,160,27,.95)':'rgba(255,255,255,.3)';
      ctx.lineWidth=inZone?2.4:1.5;
      ctx.beginPath();for(let i=0;i<=40;i++){const{bx,by}=arcPt(i/40,sc);i===0?ctx.moveTo(bx,by):ctx.lineTo(bx,by);}
      ctx.stroke();ctx.setLineDash([]);ctx.restore();
      if(inZone){ctx.strokeStyle='rgba(249,160,27,.5)';ctx.lineWidth=3;ctx.beginPath();ctx.ellipse(hoopX,hoopY,rimR+7,8,0,0,Math.PI*2);ctx.stroke();}
      drawBall(ballX,ballY);hoopAF=requestAnimationFrame(frame);
    } else if(phase==='fly'){
      flyT+=.032;const{bx,by}=arcPt(flyT,flyScatter);drawBall(bx,by);
      if(flyT<1)hoopAF=requestAnimationFrame(frame);else resolveShot(Math.abs(flyScatter)<sweetW);
    } else {drawBall(ballX,ballY);hoopAF=requestAnimationFrame(frame);}
  }
  function resolveShot(made){
    const pip=document.getElementById('sp'+shotsDone);shotsDone++;
    if(made){
      if(pip){pip.classList.remove('pending');pip.classList.add('made');pip.textContent='‚úì';}
      swish=1;cancelAnimationFrame(hoopAF);
      ctx.clearRect(0,0,W,H);drawHoop();ctx.globalAlpha=.4;ctx.fillStyle='#F9A01B';ctx.beginPath();ctx.arc(hoopX,hoopY,rimR+16,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
      document.getElementById('throw-btn').disabled=true;
      setTimeout(autoCatch,600);
    } else {
      if(pip){pip.classList.remove('pending');pip.classList.add('miss');pip.textContent='‚úó';}
      if(shotsDone>=3){
        cancelAnimationFrame(hoopAF);document.getElementById('throw-btn').disabled=true;
        setTimeout(()=>{document.getElementById('fail-msg').style.display='block';setTimeout(closeModal,1800);},300);
      } else {phase='between';hoopAF=requestAnimationFrame(frame);setTimeout(()=>{phase='aim';},500);}
    }
  }
  function autoCatch(){
    const p=currentTarget; if(!p) return;
    caught.add(p.id);
    cardCounts[p.id]=(cardCounts[p.id]||0)+1;
    updateCounts();doDeSpawn(p.id);saveState();
    if(!p.isBear) checkBearUnlock();
    if(hoopAF) cancelAnimationFrame(hoopAF);
    document.getElementById('success-screen').style.display='block';
    setTimeout(closeModal,1900);
    if(document.getElementById('court-view').classList.contains('active')) rebuildRoamers();
    if(document.getElementById('cards-view').classList.contains('active')) renderCards();
  }
  window._doThrow=()=>{if(phase!=='aim')return;flyScatter=scatter();flyT=0;phase='fly';};
  hoopAF=requestAnimationFrame(frame);
}

function doThrow(){if(window._doThrow)window._doThrow();}
function closeModal(){
  if(hoopAF)cancelAnimationFrame(hoopAF);
  document.getElementById('catch-modal').classList.remove('open');
  window._doThrow=null;currentTarget=null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COUNTS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateCounts() {
  const unique=PLAYERS.filter(p=>caught.has(p.id)).length;
  document.getElementById('caught-count').textContent=unique;
  const dn=document.getElementById('dex-n'); if(dn)dn.textContent=unique;
  const df=document.getElementById('dex-fill'); if(df)df.style.width=(unique/PLAYERS.length*100)+'%';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CARDS ‚Äî only caught, sorted by rarity then lastName
   No placeholders. Jersey # always visible.
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderCards() {
  const grid=document.getElementById('cards-grid'); if(!grid) return;
  // Gather caught regular players sorted
  let toShow = sortedPlayers(PLAYERS.filter(p=>caught.has(p.id)));
  // Bear goes at front if unlocked
  if (bearUnlocked && caught.has(999)) toShow = [BEAR, ...toShow];
  // Custom player card at end if saved
  if (customPlayer) toShow.push(customPlayer);

  if(!toShow.length){
    grid.innerHTML=`<div style="grid-column:1/-1;font-family:'Barlow Condensed',sans-serif;color:rgba(245,240,232,.35);font-size:1rem;padding:40px 0;text-align:center">Catch players on the Map to see their cards here!</div>`;
    return;
  }
  grid.innerHTML=toShow.map(p=>buildCardHTML(p, cardCounts[p.id]||1)).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DEX ‚Äî all players silhouette until caught,
         sorted by rarity then lastName
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderDex() {
  const grid=document.getElementById('dex-grid'); if(!grid) return;
  updateCounts();
  let list = sortedPlayers(PLAYERS);
  if (bearUnlocked) list = [BEAR,...list];

  const totalNeeded = PLAYERS.length;
  const caughtCount = PLAYERS.filter(p=>caught.has(p.id)).length;
  const missing = PLAYERS.filter(p=>!caught.has(p.id));
  const nearComplete = caughtCount >= totalNeeded - 5; // highlight when 5 or fewer remain

  // Show missing indicator banner when close to complete
  const missingBanner = nearComplete && missing.length > 0
    ? `<div class="dex-missing-label">üî¥ <strong>${missing.length} remaining:</strong> ${missing.map(p=>p.short).join(', ')}</div>`
    : '';

  grid.innerHTML = missingBanner + list.map(p=>{
    const got=caught.has(p.id);
    const isMissing = !got && nearComplete;
    return `<div class="dex-slot ${got?'got':''} ${isMissing?'missing':''}">
      <div class="dex-char">${buildChar(p,42)}</div>
      <div class="dex-pname">${got?p.short:'???'}</div>
    </div>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ROSTER SELECTOR ‚Äî 5 fixed slots, click to swap
   Clicking a filled slot opens picker on that slot index.
   The slot is replaced in-place, not moved.
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderRosterBar() {
  const bar=document.getElementById('roster-bar');
  const hint=document.getElementById('roster-hint');
  if(!bar) return;
  const MAX=5;
  let html='';
  for(let i=0;i<MAX;i++){
    const pid=courtRoster[i];
    if(pid!==undefined){
      const p=pid==='cp'?customPlayer:(pid===999?BEAR:PLAYERS.find(pl=>pl.id===pid));
      if(p){
        const col=RARITY_COLORS[p.rarity]||'#F9A01B';
        html+=`<div class="roster-slot filled" title="${p.name} ‚Äî tap to swap" onclick="openPicker(${i})" style="border-color:${col}">
          ${buildChar(p,38)}
        </div>`;
      } else {
        html+=`<div class="roster-slot" onclick="openPicker(${i})">+</div>`;
      }
    } else {
      html+=`<div class="roster-slot" onclick="openPicker(${i})">+</div>`;
    }
  }
  bar.innerHTML=html;
  const filled=courtRoster.filter(x=>x!==undefined).length;
  if(hint) hint.textContent=filled===0?'Tap + to add players (up to 5)':'Tap any slot to swap ‚Äî hover to remove';
}

let pickerSlotIdx=null;
function openPicker(slotIdx) {
  pickerSlotIdx=slotIdx;
  const grid=document.getElementById('picker-grid'); if(!grid) return;
  // Build available list: caught players + custom player (if saved) + bear (if unlocked)
  const available=PLAYERS.filter(p=>caught.has(p.id));
  if(customPlayer) available.push({...customPlayer}); // custom player always available if saved
  if(bearUnlocked&&caught.has(999)) available.push(BEAR);

  const currentInSlot=courtRoster[slotIdx];
  grid.innerHTML=available.map(p=>{
    const isThis=currentInSlot===p.id;
    const onCourt=courtRoster.includes(p.id)&&!isThis;
    return `<div class="picker-item ${isThis?'on-court':''}" onclick="selectInSlot(${JSON.stringify(p.id)})">
      <div class="pi-char">${buildChar(p,40)}</div>
      <div class="pi-name">${p.short}</div>
      ${isThis?'<div style="font-size:.5rem;color:var(--gold);font-family:\'Barlow Condensed\',sans-serif">IN THIS SLOT</div>':''}
      ${onCourt&&!isThis?'<div style="font-size:.5rem;color:rgba(245,240,232,.35);font-family:\'Barlow Condensed\',sans-serif">ON COURT</div>':''}
    </div>`;
  }).join('');

  // Add a "remove" option if slot is filled
  if(currentInSlot!==undefined){
    grid.innerHTML+=`<div class="picker-item" onclick="clearSlot(${slotIdx})" style="border-color:var(--red);color:var(--red)">
      <div class="pi-char" style="font-size:1.4rem;height:44px;display:flex;align-items:center;justify-content:center">‚úï</div>
      <div class="pi-name">Remove</div>
    </div>`;
  }

  if(!available.length) grid.innerHTML=`<div style="font-family:'Barlow Condensed',sans-serif;color:rgba(245,240,232,.5);padding:20px;text-align:center">Catch players first!</div>`;
  document.getElementById('picker-overlay').classList.add('open');
}

function selectInSlot(pid) {
  if(pickerSlotIdx===null) return;
  // If player is already in another slot, swap them
  const existingSlot=courtRoster.indexOf(pid);
  if(existingSlot!==-1&&existingSlot!==pickerSlotIdx){
    const displaced=courtRoster[pickerSlotIdx];
    courtRoster[existingSlot]=displaced;
  }
  courtRoster[pickerSlotIdx]=pid;
  closePicker(); saveState(); rebuildRoamers(); renderRosterBar();
}

function clearSlot(slotIdx) {
  courtRoster.splice(slotIdx,1,undefined);
  // Trim trailing undefineds
  while(courtRoster.length&&courtRoster[courtRoster.length-1]===undefined) courtRoster.pop();
  closePicker(); saveState(); rebuildRoamers(); renderRosterBar();
}

function closePicker(){document.getElementById('picker-overlay').classList.remove('open');pickerSlotIdx=null;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   COURT ‚Äî roamers + canvas ball
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function rebuildRoamers() {
  const court=document.getElementById('roam-court');
  const footer=document.getElementById('court-footer-top');
  const players=courtRoster
    .filter(id=>id!==undefined)
    .map(id=>{
      if(id==='cp') return customPlayer;  // custom player by string id
      if(id===999)  return BEAR;
      return PLAYERS.find(p=>p.id===id);
    })
    .filter(Boolean);

  court.querySelectorAll('.roamer-div').forEach(r=>r.remove());
  if(courtAF){cancelAnimationFrame(courtAF);courtAF=null;}
  if(roamTimer){clearInterval(roamTimer);roamTimer=null;}
  const cv=document.getElementById('court-cv');
  if(cv){cv.width=court.offsetWidth||900;cv.height=court.offsetHeight||490;}

  if(!players.length){
    if(footer) footer.textContent='Use the slots below to put players on the court!';
    renderRosterBar(); return;
  }
  if(footer) footer.textContent=players.length===1
    ?`${players[0].short} is warming up! üèÄ`
    :`${players.map(p=>p.short).join(', ')} running drills üèÄ`;

  players.forEach(p=>{
    if(!roamPos[p.id]) roamPos[p.id]={x:20+Math.random()*60,y:20+Math.random()*60};
    const el=document.createElement('div');
    el.className='roamer-div';el.id='rv-'+p.id;
    el.style.left=roamPos[p.id].x+'%';el.style.top=roamPos[p.id].y+'%';
    el.innerHTML=`${buildChar(p,50)}<div class="roamer-tag" style="color:${RARITY_COLORS[p.rarity]||'#F9A01B'}">${p.short}</div>`;
    court.appendChild(el);
  });

  roamTimer=setInterval(()=>{
    players.forEach(p=>{
      const pos=roamPos[p.id]; if(!pos) return;
      pos.x=Math.max(8,Math.min(92,pos.x+(Math.random()-.5)*14));
      pos.y=Math.max(10,Math.min(90,pos.y+(Math.random()-.5)*14));
      const el=document.getElementById('rv-'+p.id);
      if(el){el.style.left=pos.x+'%';el.style.top=pos.y+'%';}
    });
  },4500);

  if(players.length===1) startDribble(players[0]);
  else startPassing(players);
  renderRosterBar();
}

function startDribble(player) {
  const canvas=document.getElementById('court-cv'); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  let t=0,tDir=1;
  const SPEED=0.045;
  // SVG viewBox is 56x60, character feet at bottom (y=60), arms at y‚âà33, hand tip at x‚âà52 y‚âà33
  // We render at size 50 ‚Üí scale factor = 50/56 ‚âà 0.89
  // Player div is positioned translate(-50%,-100%) so feet = courtY, head = courtY - charH
  // charH at size50 = Math.round(50*1.07)=54px. Hand is roughly 54*(33/60)=29.7px from feet up
  // Horizontal: right arm tip at 52/56 * 50 = 46px from left, center offset = 50/2=25, so hand is +21px right of center
  const CHAR_H = Math.round(50*1.07); // rendered SVG height
  const HAND_UP_FRAC = 33/60;         // hand y in SVG coords / total height
  const HAND_X_OFFSET = 12;           // px right of character center (arm extends right)

  function getPos(){
    const pos=roamPos[player.id]||{x:50,y:50};
    // feet position in canvas pixels
    const feetX=(pos.x/100)*canvas.width;
    const feetY=(pos.y/100)*canvas.height;
    // hand position: right of center, partway up from feet
    const handX = feetX + HAND_X_OFFSET;
    const handY = feetY - CHAR_H * HAND_UP_FRAC;
    return {handX, handY, feetY};
  }

  function drawBall(x,y){
    const r=9;
    const g=ctx.createRadialGradient(x-r*.3,y-r*.3,r*.12,x,y,r);
    g.addColorStop(0,'#ffb347');g.addColorStop(1,'#c84800');
    ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.25)';ctx.lineWidth=1;
    ctx.beginPath();ctx.arc(x,y,r,-.4,.4);ctx.stroke();
  }

  function frame(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const{handX,handY,feetY}=getPos();
    // Ball bounces from hand (top) down to just above floor (bottom)
    const eased=Math.pow(t,.55); // ease-in so it spends more time at top (hand)
    const bx=handX;
    const by=handY + eased*(feetY - handY - 6); // -6 so doesn't sink into floor
    // Floor shadow grows as ball approaches ground
    const shadowAlpha=0.15+0.2*eased;
    const shadowW=7+5*eased;
    ctx.globalAlpha=shadowAlpha;ctx.fillStyle='#000';
    ctx.beginPath();ctx.ellipse(bx,feetY+2,shadowW,3,0,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;
    drawBall(bx,by);
    t+=tDir*SPEED;if(t>=1){t=1;tDir=-1;}if(t<=0){t=0;tDir=1;}
    courtAF=requestAnimationFrame(frame);
  }
  courtAF=requestAnimationFrame(frame);
}

function startPassing(players) {
  const canvas=document.getElementById('court-cv'); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  let fromIdx=0,toIdx=1,t=0;
  const SPEED=0.012;
  function getPos(p){const pos=roamPos[p.id]||{x:50,y:50};return{x:(pos.x/100)*canvas.width,y:(pos.y/100)*canvas.height};}
  function arcPt(t,f,to){const cpX=(f.x+to.x)*.5,cpY=Math.min(f.y,to.y)-canvas.height*.28;return{x:(1-t)*(1-t)*f.x+2*(1-t)*t*cpX+t*t*to.x,y:(1-t)*(1-t)*f.y+2*(1-t)*t*cpY+t*t*to.y};}
  function drawBall(x,y){const r=9;const g=ctx.createRadialGradient(x-r*.3,y-r*.3,r*.12,x,y,r);g.addColorStop(0,'#ffb347');g.addColorStop(1,'#c84800');ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();ctx.strokeStyle='rgba(0,0,0,.25)';ctx.lineWidth=1;ctx.beginPath();ctx.arc(x,y,r,-.4,.4);ctx.stroke();}
  function frame(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const from=players[fromIdx],to=players[toIdx];
    if(!from||!to){courtAF=requestAnimationFrame(frame);return;}
    const fp=getPos(from),tp=getPos(to);t+=SPEED;
    const{x:bx,y:by}=arcPt(t,fp,tp);
    const floorY=fp.y+(tp.y-fp.y)*t,ht=Math.sin(Math.PI*t);
    ctx.save();ctx.globalAlpha=.22*ht;ctx.fillStyle='#000';ctx.beginPath();ctx.ellipse(bx,floorY+6,10*(.4+.6*ht),3,0,0,Math.PI*2);ctx.fill();ctx.restore();
    drawBall(bx,by);
    if(t>=1){t=0;fromIdx=toIdx;const others=players.map((_,i)=>i).filter(i=>i!==fromIdx);toIdx=others[Math.floor(Math.random()*others.length)];setTimeout(()=>{courtAF=requestAnimationFrame(frame);},500);return;}
    courtAF=requestAnimationFrame(frame);
  }
  courtAF=requestAnimationFrame(frame);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   VIEW SWITCHER
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showView(id,btn) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  if(id==='court-view')  rebuildRoamers();
  if(id==='dex-view')    renderDex();
  if(id==='cards-view')  renderCards();
  if(id==='faces-view')  renderFaces();
  if(id==='custom-view') initCustomView();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SOCIAL EXPORT STUB
   (wire up to Firebase when ready)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function exportPlayerData() {
  return {
    caught:[...caught],
    cardCounts,
    customPlayer,
    totalPlayMs:totalPlayMs+(Date.now()-sessionStart),
    lastSeen:new Date().toISOString(),
    // TODO: add uid, friendsList when accounts implemented
  };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
loadState();
updateCounts();
// Bear nav tab is gone ‚Äî bear unlocks secretly
if(bearUnlocked && !caught.has(999)){caught.add(999);cardCounts[999]=1;}
renderCards();
renderDex();
renderFaces();
document.getElementById('total-count').textContent=PLAYERS.length;
document.getElementById('dex-total').textContent=PLAYERS.length;
document.getElementById('save-badge').style.opacity='0';
// Autosave play time every 2 min
setInterval(saveState, 120000);
scheduleAll();
if(bearUnlocked) scheduleBear();
</script>
</body>
</html>