<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JazzDex</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:wght@400;600;700&family=Barlow:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê BRAND COLORS ‚ïê‚ïê */
:root {
  --navy:#002B5C; --gold:#F9A01B; --teal:#00B2A9;
  --red:#C8102E; --cream:#F5F0E8; --bg:#001525;
  --common:#00B2A9; --rare:#7C4DFF; --epic:#FF6D00; --legendary:#F9A01B;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--cream);font-family:'Barlow',sans-serif;min-height:100vh;overflow-x:hidden;}

/* HEADER */
header{background:linear-gradient(135deg,#002044,#001020);border-bottom:3px solid var(--gold);padding:10px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:4px;color:var(--gold);text-shadow:0 0 24px rgba(249,160,27,.5);}
.logo span{color:var(--teal);}
.hdr-right{display:flex;align-items:center;gap:16px;}
.hdr-stats{font-family:'Barlow Condensed',sans-serif;font-size:.85rem;color:rgba(245,240,232,.55);display:flex;gap:16px;}
.hdr-stats strong{color:var(--gold);font-size:1.1rem;}
.save-badge{font-family:'Barlow Condensed',sans-serif;font-size:.7rem;color:rgba(245,240,232,.3);opacity:0;transition:opacity .3s;}

/* NAV */
nav{background:var(--navy);display:flex;justify-content:center;gap:3px;padding:6px 10px;border-bottom:1px solid rgba(249,160,27,.2);flex-wrap:wrap;}
.nav-btn{background:transparent;border:2px solid transparent;color:rgba(245,240,232,.55);font-family:'Barlow Condensed',sans-serif;font-size:.88rem;font-weight:700;letter-spacing:1px;padding:6px 14px;cursor:pointer;border-radius:4px;transition:all .2s;text-transform:uppercase;}
.nav-btn:hover{color:var(--gold);border-color:rgba(249,160,27,.3);}
.nav-btn.active{background:var(--gold);color:var(--navy);border-color:var(--gold);}

/* VIEWS */
.view{display:none;}.view.active{display:block;}
.view-inner{padding:20px;max-width:960px;margin:0 auto;}
.view-title{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:3px;color:var(--gold);margin-bottom:16px;display:flex;align-items:center;gap:10px;}
.view-title::after{content:'';flex:1;height:2px;background:linear-gradient(90deg,rgba(249,160,27,.5),transparent);}

/* COURT FLOOR */
.court-wrap{position:relative;width:calc(100% - 32px);max-width:1400px;margin:16px auto;overflow:hidden;border: 4px solid var(--gold); border-radius:12px;}
.court-wrap::before{content:'';display:block;padding-top: min(54%, calc(100vh - 180px));}
.court-wrap svg.floor{position:absolute;inset:0;width:100%;height:100%;}

#map-view.active{display:flex;flex-direction:column;height:calc(100vh - 115px);}
#map-view .court-wrap{position:relative;width:calc(100% - 32px);max-width:none;margin:12px auto;overflow:hidden;border:4px solid var(--gold);border-radius:10px;}
#map-view .court-wrap::before{content:'';display:block;padding-top:54.5%;}
#map-view .map-legend{flex-shrink:0;width:calc(100% - 32px);max-width:none;margin:0 auto 12px;border-radius:6px;}

#court-view.active{display:flex;flex-direction:column;height:calc(100vh - 115px);}
.roam-court{position:relative;width:calc(100% - 32px);max-width:none;margin:12px auto 0;overflow:hidden;border:4px solid var(--gold);border-radius:10px;}
.roam-court::before{content:'';display:block;padding-top:54.5%;}
.roam-court svg.floor{position:absolute;inset:0;width:100%;height:100%;z-index:1;}
.court-footer{flex-shrink:0;width:calc(100% - 32px);max-width:none;margin:0 auto 12px;border-top:1px solid rgba(249,160,27,.2);border-radius:6px;}

/* MAP SPAWNS */
.spawn-char{position:absolute;transform:translate(-50%,-100%);cursor:pointer;z-index:20;transition:left 9s ease-in-out,top 9s ease-in-out;display:flex;flex-direction:column;align-items:center;}
.spawn-char.popin{animation:pop-in .4s cubic-bezier(.175,.885,.32,1.275) forwards;}
.spawn-char.popout{animation:pop-out .3s ease-in forwards;pointer-events:none;}
@keyframes pop-in{from{transform:translate(-50%,-100%) scale(0);opacity:0}to{transform:translate(-50%,-100%) scale(1);opacity:1}}
@keyframes pop-out{to{transform:translate(-50%,-100%) scale(0) rotate(12deg);opacity:0}}
.char-body{display:flex;flex-direction:column;align-items:center;}
.char-shadow{width:26px;height:6px;background:rgba(0,0,0,.4);border-radius:50%;margin-top:-2px;animation:sh-bob 1.8s ease-in-out infinite;}
@keyframes sh-bob{0%,100%{transform:scaleX(1)}50%{transform:scaleX(.6)}}
.char-tag{font-family:'Barlow Condensed',sans-serif;font-size:.6rem;font-weight:700;background:rgba(0,0,0,.8);padding:2px 6px;border-radius:3px;white-space:nowrap;margin-top:4px;letter-spacing:.4px;border-left:2px solid currentColor;}
.map-legend{background:var(--navy);padding:10px 20px;display:flex;gap:16px;flex-wrap:wrap;align-items:center;font-family:'Barlow Condensed',sans-serif;font-size:.82rem;border-top:1px solid rgba(249,160,27,.2);max-width:960px;margin:0 auto;}
.leg-item{display:flex;align-items:center;gap:6px;}
.leg-dot{width:10px;height:10px;border-radius:50%;}
.map-hint{color:rgba(245,240,232,.4);font-size:.78rem;margin-left:auto;font-style:italic;}

/* CATCH MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,8,25,.93);z-index:300;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.modal-overlay.open{display:flex;}
.catch-modal{background:linear-gradient(160deg,#001830,#002244);border:2px solid var(--gold);border-radius:18px;padding:24px 28px;width:min(440px,96vw);position:relative;box-shadow:0 0 80px rgba(249,160,27,.2);animation:modal-in .35s cubic-bezier(.175,.885,.32,1.275);}
@keyframes modal-in{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.modal-close{position:absolute;top:12px;right:14px;background:none;border:none;color:rgba(255,255,255,.4);font-size:1.4rem;cursor:pointer;}
.modal-close:hover{color:#fff;}
.modal-header{display:flex;align-items:center;gap:16px;margin-bottom:16px;}
.modal-char{flex-shrink:0;}.modal-info{flex:1;}
.modal-name{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:3px;color:var(--gold);line-height:1;}
.modal-rbadge{font-family:'Barlow Condensed',sans-serif;font-size:.72rem;font-weight:700;letter-spacing:2px;padding:2px 10px;border-radius:20px;text-transform:uppercase;display:inline-block;margin-top:4px;}
.hoop-section{background:rgba(0,0,0,.35);border-radius:12px;padding:16px;}
.hoop-title{font-family:'Barlow Condensed',sans-serif;font-size:.85rem;color:rgba(245,240,232,.6);text-align:center;margin-bottom:10px;letter-spacing:1px;}
.shot-row{display:flex;justify-content:center;gap:10px;margin-bottom:10px;}
.shot-pip{width:32px;height:32px;border-radius:50%;border:2px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:.9rem;transition:all .25s;}
.shot-pip.made{background:var(--gold);border-color:var(--gold);transform:scale(1.1);}
.shot-pip.miss{background:var(--red);border-color:var(--red);}
.shot-pip.pending{opacity:.4;}
canvas#hoop-cv{width:100%;height:150px;display:block;border-radius:8px;background:rgba(0,0,10,.4);}
.throw-btn{margin-top:10px;width:100%;background:linear-gradient(135deg,var(--gold),#c87c00);color:var(--navy);border:none;font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:3px;padding:10px;border-radius:8px;cursor:pointer;box-shadow:0 4px 18px rgba(249,160,27,.35);transition:transform .1s;}
.throw-btn:active{transform:scale(.97);}.throw-btn:disabled{opacity:.35;cursor:not-allowed;}
.fail-msg{display:none;text-align:center;color:var(--red);font-family:'Barlow Condensed',sans-serif;font-size:1rem;margin-top:8px;}
.success-screen{display:none;text-align:center;padding:16px 0;}
.success-screen h3{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--gold);letter-spacing:4px;}
.success-screen p{font-family:'Barlow Condensed',sans-serif;color:rgba(245,240,232,.7);}
.burst{font-size:2.8rem;display:block;margin-bottom:8px;animation:burst .5s ease 4;}
@keyframes burst{0%,100%{transform:scale(1)}50%{transform:scale(1.4)}}

/* PLAYER CARDS */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:16px;}
.card-flip-wrap{perspective:700px;height:270px;cursor:pointer;position:relative;}
.card-inner{position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .55s cubic-bezier(.4,0,.2,1);border-radius:14px;}
.card-flip-wrap.flipped .card-inner{transform:rotateY(180deg);}
.card-face{position:absolute;inset:0;backface-visibility:hidden;border-radius:14px;overflow:hidden;background:linear-gradient(160deg,#001830,var(--navy));}
.card-back{transform:rotateY(180deg);}
.card-flip-wrap[data-r="common"] .card-face{border:2px solid var(--common);box-shadow:0 4px 16px rgba(0,178,169,.2);}
.card-flip-wrap[data-r="rare"] .card-face{border:2px solid var(--rare);box-shadow:0 4px 16px rgba(124,77,255,.25);}
.card-flip-wrap[data-r="epic"] .card-face{border:2px solid var(--epic);box-shadow:0 4px 20px rgba(255,109,0,.3);}
.card-flip-wrap[data-r="legendary"] .card-face{border:2px solid var(--legendary);box-shadow:0 4px 28px rgba(249,160,27,.4);animation:cardleg 3s ease-in-out infinite;}
@keyframes cardleg{0%,100%{box-shadow:0 4px 28px rgba(249,160,27,.4)}50%{box-shadow:0 4px 50px rgba(249,160,27,.7)}}
/* Card count badge ‚Äî always visible, never hides */
.card-count-badge{position:absolute;top:8px;right:8px;z-index:10;background:rgba(0,0,0,.82);color:var(--gold);font-family:'Bebas Neue',sans-serif;font-size:.85rem;padding:2px 8px;border-radius:10px;border:1px solid rgba(249,160,27,.45);pointer-events:none;}
/* Card jersey number badge */
.card-jersey-badge{position:absolute;top:8px;left:8px;z-index:10;background:rgba(0,0,0,.7);color:rgba(245,240,232,.7);font-family:'Bebas Neue',sans-serif;font-size:.8rem;padding:2px 7px;border-radius:10px;pointer-events:none;}
/* Front face */
.card-front-img{width:100%;height:100%;object-fit:cover;display:block;}
.card-front-overlay{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.8));padding:20px 10px 10px;}
.card-front-overlay .card-pname{font-family:'Bebas Neue',sans-serif;font-size:1.25rem;letter-spacing:2px;color:#fff;}
.card-front-overlay .card-rbadge{font-family:'Barlow Condensed',sans-serif;font-size:.6rem;font-weight:700;letter-spacing:2px;padding:2px 7px;border-radius:20px;text-transform:uppercase;display:inline-block;margin-top:2px;}
.card-front-noimg{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:6px;padding:12px;}
.card-front-noimg .card-char{height:90px;display:flex;align-items:flex-end;justify-content:center;}
.card-front-noimg .card-pname{font-family:'Bebas Neue',sans-serif;font-size:1.15rem;letter-spacing:2px;text-align:center;}
.card-front-noimg .card-era{font-family:'Barlow Condensed',sans-serif;font-size:.68rem;color:rgba(245,240,232,.4);text-align:center;}
/* Back face */
.card-back-inner{padding:14px;height:100%;display:flex;flex-direction:column;}
.card-back-num{font-family:'Barlow Condensed',sans-serif;font-size:.7rem;color:rgba(245,240,232,.35);}
.card-back-name{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px;color:var(--gold);line-height:1;margin-bottom:2px;}
.card-back-era{font-family:'Barlow Condensed',sans-serif;font-size:.68rem;color:rgba(245,240,232,.4);margin-bottom:10px;}
.card-back-stats{background:rgba(0,0,0,.3);border-radius:8px;padding:8px 10px;display:grid;grid-template-columns:1fr 1fr;gap:4px 8px;margin-bottom:8px;}
.srow{display:flex;justify-content:space-between;font-family:'Barlow Condensed',sans-serif;font-size:.82rem;}
.sl{color:rgba(245,240,232,.45);}.sv{font-weight:600;}
.card-back-quote{font-family:'Barlow Condensed',sans-serif;font-size:.7rem;color:rgba(245,240,232,.4);font-style:italic;text-align:center;margin-top:auto;padding-top:6px;}
.card-back-hint{font-family:'Barlow Condensed',sans-serif;font-size:.6rem;color:rgba(245,240,232,.2);text-align:center;margin-top:4px;}

/* DEX */
.dex-bar-wrap{background:rgba(0,0,0,.3);border-radius:8px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:14px;}
.dex-track{flex:1;height:12px;background:rgba(0,0,0,.4);border-radius:6px;overflow:hidden;border:1px solid rgba(249,160,27,.2);}
.dex-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--gold));border-radius:6px;transition:width .5s;}
.dex-frac{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--gold);letter-spacing:2px;white-space:nowrap;}
.dex-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(78px,1fr));gap:8px;}
.dex-slot{border:2px solid rgba(249,160,27,.15);border-radius:10px;padding:7px 4px;text-align:center;background:rgba(0,20,50,.5);transition:all .2s;}
.dex-slot.got{border-color:var(--gold);background:rgba(0,30,70,.8);cursor:pointer;}
.dex-slot.got:hover{transform:scale(1.06);}
.dex-char{display:flex;justify-content:center;align-items:flex-end;height:50px;margin-bottom:3px;}
.dex-pname{font-family:'Barlow Condensed',sans-serif;font-size:.62rem;font-weight:700;letter-spacing:.3px;}
.dex-slot:not(.got) .dex-char{filter:brightness(0) opacity(.25);}
.dex-slot:not(.got) .dex-pname{color:rgba(255,255,255,.15);}
/* "missing" highlight for completion hunting */
.dex-slot.missing{border-color:rgba(200,16,46,.55);background:rgba(200,16,46,.07);animation:missing-pulse 2.5s ease-in-out infinite;}
@keyframes missing-pulse{0%,100%{border-color:rgba(200,16,46,.4)}50%{border-color:rgba(200,16,46,.9);box-shadow:0 0 10px rgba(200,16,46,.3)}}
.dex-missing-label{font-family:'Barlow Condensed',sans-serif;font-size:.75rem;color:rgba(200,16,46,.8);margin-bottom:12px;display:flex;align-items:center;gap:6px;}
.dex-missing-label strong{color:#ff4a4a;}

/* COURT */
#court-view{padding:0;}
.roam-court{position:relative;width:calc(100% - 32px);max-width:1400px;margin:16px auto;overflow:hidden;border:4px solid var(--gold);}
.roam-court::before{content:'';display:block;padding-top:min(54%, calc(100vh - 220px));}
.roam-court svg.floor{position:absolute;inset:0;width:100%;height:100%;z-index:1;}
.roamer-div{position:absolute;transform:translate(-50%,-100%);pointer-events:none;transition:left 4.5s ease-in-out,top 4.5s ease-in-out;display:flex;flex-direction:column;align-items:center;z-index:2;}
.roamer-tag{font-family:'Barlow Condensed',sans-serif;font-size:.6rem;font-weight:700;background:rgba(0,0,0,.75);padding:2px 5px;border-radius:3px;white-space:nowrap;margin-top:3px;}
.roam-court canvas#court-cv{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:3;}
.court-footer{background:var(--navy);padding:10px 16px;max-width:960px;margin:0 auto;border-top:1px solid rgba(249,160,27,.2);}
.court-footer-top{font-family:'Barlow Condensed',sans-serif;font-size:.9rem;color:rgba(245,240,232,.5);text-align:center;margin-bottom:8px;}

/* ROSTER ‚Äî inline edit, stays in place */
.roster-bar{display:flex;align-items:center;justify-content:center;gap:6px;flex-wrap:wrap;}
.roster-slot{
  width:54px;height:54px;border-radius:50%;
  border:2px dashed rgba(249,160,27,.3);background:rgba(0,0,0,.25);
  display:flex;align-items:center;justify-content:center;
  font-size:.65rem;color:rgba(245,240,232,.3);font-family:'Barlow Condensed',sans-serif;
  cursor:pointer;transition:border-color .2s,background .2s;position:relative;overflow:hidden;
  flex-shrink:0;
}
.roster-slot.filled{border-color:var(--gold);border-style:solid;border-width:2px;overflow:visible;}
.roster-slot.filled:hover::after{content:'‚úï';position:absolute;inset:0;border-radius:50%;background:rgba(200,16,46,.75);display:flex;align-items:center;justify-content:center;font-size:1rem;color:#fff;}
.roster-slot svg,.roster-slot img{pointer-events:none;}
.roster-hint{font-family:'Barlow Condensed',sans-serif;font-size:.68rem;color:rgba(245,240,232,.28);text-align:center;margin-top:5px;}

/* PLAYER PICKER */
.picker-overlay{display:none;position:fixed;inset:0;background:rgba(0,8,25,.9);z-index:400;align-items:center;justify-content:center;}
.picker-overlay.open{display:flex;}
.picker-modal{background:linear-gradient(160deg,#001830,#002244);border:2px solid var(--teal);border-radius:16px;padding:20px;width:min(500px,96vw);max-height:80vh;overflow-y:auto;}
.picker-title{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:2px;color:var(--teal);margin-bottom:4px;}
.picker-sub{font-family:'Barlow Condensed',sans-serif;font-size:.78rem;color:rgba(245,240,232,.4);margin-bottom:12px;}
.picker-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;}
.picker-item{border:2px solid rgba(255,255,255,.1);border-radius:8px;padding:8px 4px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(0,20,50,.5);}
.picker-item:hover{border-color:var(--teal);background:rgba(0,178,169,.1);}
.picker-item.on-court{border-color:var(--gold);background:rgba(249,160,27,.1);}
.picker-item .pi-char{height:44px;display:flex;align-items:flex-end;justify-content:center;}
.picker-item .pi-name{font-family:'Barlow Condensed',sans-serif;font-size:.62rem;font-weight:700;margin-top:2px;}
.picker-close{float:right;background:none;border:none;color:rgba(255,255,255,.4);font-size:1.4rem;cursor:pointer;}

/* FACES PANEL */
.faces-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:14px;}
.face-slot{background:rgba(0,20,50,.6);border:2px dashed rgba(249,160,27,.25);border-radius:12px;padding:12px 8px;text-align:center;transition:border-color .2s;}
.face-slot:hover{border-color:rgba(249,160,27,.7);}
.face-slot label{cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;}
.face-preview{width:54px;height:54px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:1.5rem;}
.face-preview img{width:100%;height:100%;object-fit:cover;}
.face-pname{font-family:'Barlow Condensed',sans-serif;font-size:.72rem;font-weight:700;color:var(--cream);letter-spacing:.4px;}
.face-sub{font-size:.6rem;color:rgba(245,240,232,.4);}
.face-slot input[type=file]{display:none;}

/* CUSTOM PLAYER */
.custom-creator{background:rgba(0,20,50,.5);border:2px solid rgba(249,160,27,.3);border-radius:16px;padding:24px;max-width:520px;margin:0 auto;}
.custom-preview-area{display:flex;align-items:flex-end;justify-content:center;height:110px;margin-bottom:16px;gap:16px;}
.cp-live-stats{font-family:'Barlow Condensed',sans-serif;font-size:.75rem;color:rgba(245,240,232,.5);display:flex;flex-direction:column;gap:3px;align-self:center;}
.cp-live-stats span{color:var(--gold);}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-grid.wide{grid-template-columns:1fr;}
.form-field{display:flex;flex-direction:column;gap:4px;}
.form-field label{font-family:'Barlow Condensed',sans-serif;font-size:.75rem;font-weight:700;color:rgba(245,240,232,.5);letter-spacing:1px;text-transform:uppercase;}
.form-field input,.form-field select{background:rgba(0,0,0,.4);border:1px solid rgba(249,160,27,.25);border-radius:6px;padding:8px 10px;color:var(--cream);font-family:'Barlow Condensed',sans-serif;font-size:.95rem;width:100%;}
.form-field input:focus,.form-field select:focus{outline:none;border-color:var(--gold);}
.form-field select option{background:#001525;}
.face-upload-btn{display:flex;align-items:center;justify-content:center;gap:8px;background:rgba(0,178,169,.15);border:2px dashed rgba(0,178,169,.4);border-radius:8px;padding:10px;cursor:pointer;font-family:'Barlow Condensed',sans-serif;font-size:.85rem;color:var(--teal);transition:all .2s;width:100%;}
.face-upload-btn:hover{background:rgba(0,178,169,.25);border-color:var(--teal);}
.face-upload-btn input{display:none;}
.save-player-btn{width:100%;background:linear-gradient(135deg,var(--gold),#c87c00);color:var(--navy);border:none;font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:3px;padding:12px;border-radius:8px;cursor:pointer;margin-top:16px;box-shadow:0 4px 18px rgba(249,160,27,.3);transition:transform .1s;}
.save-player-btn:active{transform:scale(.97);}
.saved-badge{text-align:center;font-family:'Barlow Condensed',sans-serif;font-size:.8rem;color:var(--teal);margin-top:8px;display:none;}
.custom-card-display{margin-top:24px;max-width:520px;margin-left:auto;margin-right:auto;}
/* custom player stats section */
.cp-stats-panel{background:rgba(0,0,0,.3);border-radius:10px;padding:12px 16px;margin-top:12px;font-family:'Barlow Condensed',sans-serif;font-size:.82rem;}
.cp-stats-panel h4{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;color:var(--gold);margin-bottom:8px;}
.cp-stat-row{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.05);}
.cp-stat-row:last-child{border-bottom:none;}
.cp-stat-label{color:rgba(245,240,232,.45);}
.cp-stat-val{color:var(--cream);font-weight:600;}

/* SOCIAL STUB */
.social-stub{background:rgba(0,20,50,.5);border:2px solid rgba(124,77,255,.3);border-radius:16px;padding:24px;text-align:center;}
.social-stub h3{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:3px;color:#a87fff;margin-bottom:8px;}
.social-stub p{font-family:'Barlow Condensed',sans-serif;font-size:.9rem;color:rgba(245,240,232,.55);line-height:1.7;margin-bottom:12px;}
.social-stub .coming-soon{display:inline-block;background:rgba(124,77,255,.2);border:1px solid rgba(124,77,255,.4);border-radius:20px;padding:4px 14px;font-family:'Barlow Condensed',sans-serif;font-size:.75rem;letter-spacing:2px;color:#a87fff;margin-bottom:12px;}
.social-feature{background:rgba(0,10,30,.4);border-radius:10px;padding:12px 16px;margin-top:10px;text-align:left;}
.social-feature h4{font-family:'Barlow Condensed',sans-serif;font-size:.9rem;font-weight:700;color:var(--teal);margin-bottom:4px;}
.social-feature p{font-family:'Barlow Condensed',sans-serif;font-size:.8rem;color:rgba(245,240,232,.45);line-height:1.5;}
.social-feature .tech-note{font-size:.72rem;color:rgba(245,240,232,.25);margin-top:4px;font-style:italic;}

/* RARITY BADGES */
.rarity-common{color:var(--common);background:rgba(0,178,169,.15);}
.rarity-rare{color:#a87fff;background:rgba(124,77,255,.15);}
.rarity-epic{color:#ff9940;background:rgba(255,109,0,.15);}
.rarity-legendary{color:var(--gold);background:rgba(249,160,27,.15);}

/* BEAR UNLOCK TOAST */
.bear-toast{position:fixed;top:70px;left:50%;transform:translateX(-50%) translateY(-20px);z-index:500;
  background:linear-gradient(135deg,#8B4513,#5a2a08);border:2px solid var(--gold);color:var(--gold);
  font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;
  padding:14px 32px;border-radius:12px;box-shadow:0 4px 40px rgba(249,160,27,.5);
  opacity:0;transition:opacity .4s,transform .4s;pointer-events:none;}
.bear-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
/* GAME TOAST */
#game-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(10px);z-index:600;
  background:linear-gradient(135deg,#001830,#002244);border:2px solid var(--teal);
  color:var(--cream);font-family:'Barlow Condensed',sans-serif;font-size:.95rem;font-weight:600;
  padding:11px 24px;border-radius:10px;box-shadow:0 4px 24px rgba(0,178,169,.3);
  opacity:0;transition:opacity .3s,transform .3s;pointer-events:none;white-space:nowrap;max-width:90vw;text-align:center;}
#game-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
/* AUTH */
.auth-btn-sm{background:transparent;border:1px solid rgba(249,160,27,.35);color:rgba(245,240,232,.65);
  font-family:'Barlow Condensed',sans-serif;font-size:.72rem;font-weight:700;letter-spacing:.5px;
  padding:4px 10px;border-radius:4px;cursor:pointer;transition:all .15s;white-space:nowrap;}
.auth-btn-sm:hover{border-color:var(--gold);color:var(--gold);}
.auth-btn-sm.gold{background:var(--gold);color:var(--navy);border-color:var(--gold);}
.auth-tab-bar{display:flex;border:1px solid rgba(249,160,27,.2);border-radius:6px;overflow:hidden;margin-bottom:16px;}
.auth-tab{flex:1;background:transparent;border:none;color:rgba(245,240,232,.4);
  font-family:'Barlow Condensed',sans-serif;font-size:.9rem;font-weight:700;letter-spacing:1px;
  padding:9px;cursor:pointer;transition:all .2s;text-transform:uppercase;}
.auth-tab.active{background:rgba(249,160,27,.15);color:var(--gold);}
.auth-input{background:rgba(0,0,0,.4);border:1px solid rgba(249,160,27,.25);border-radius:6px;
  padding:9px 12px;color:var(--cream);font-family:'Barlow Condensed',sans-serif;font-size:.95rem;
  width:100%;outline:none;transition:border-color .2s;margin-bottom:10px;}
.auth-input:focus{border-color:var(--gold);}
.auth-submit{width:100%;background:linear-gradient(135deg,var(--gold),#c87c00);color:var(--navy);
  border:none;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:3px;
  padding:11px;border-radius:8px;cursor:pointer;box-shadow:0 3px 14px rgba(249,160,27,.3);transition:opacity .15s;}
.auth-submit:hover{opacity:.88;}
.auth-divider{text-align:center;font-family:'Barlow Condensed',sans-serif;font-size:.75rem;
  color:rgba(245,240,232,.25);margin:12px 0;}
.auth-guest{width:100%;background:transparent;border:2px solid rgba(245,240,232,.15);color:rgba(245,240,232,.5);
  font-family:'Barlow Condensed',sans-serif;font-size:.9rem;font-weight:700;letter-spacing:1px;
  padding:9px;border-radius:8px;cursor:pointer;transition:all .2s;}
.auth-guest:hover{border-color:rgba(245,240,232,.35);color:var(--cream);}
.auth-err{font-family:'Barlow Condensed',sans-serif;font-size:.8rem;color:var(--red);min-height:18px;margin-bottom:8px;}
.auth-note{font-family:'Barlow Condensed',sans-serif;font-size:.7rem;color:rgba(245,240,232,.22);text-align:center;margin-top:10px;line-height:1.5;}
.auth-label{font-family:'Barlow Condensed',sans-serif;font-size:.72rem;font-weight:700;color:rgba(245,240,232,.45);letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:3px;}
/* SOCIAL */
.social-sec{background:rgba(0,18,44,.6);border:1px solid rgba(249,160,27,.15);border-radius:12px;padding:18px;margin-bottom:14px;}
.social-sec-title{font-family:'Bebas Neue',sans-serif;font-size:1.05rem;letter-spacing:2px;color:var(--gold);margin-bottom:12px;}
.social-empty{font-family:'Barlow Condensed',sans-serif;font-size:.85rem;color:rgba(245,240,232,.3);padding:8px 0;}
.user-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid rgba(255,255,255,.05);}
.user-row:last-child{border-bottom:none;}
.user-row-name{font-family:'Barlow Condensed',sans-serif;font-size:.95rem;font-weight:700;flex:1;}
.user-row-sub{font-family:'Barlow Condensed',sans-serif;font-size:.72rem;color:rgba(245,240,232,.38);}
.soc-btn{background:transparent;border:1px solid rgba(249,160,27,.35);color:var(--gold);
  font-family:'Barlow Condensed',sans-serif;font-size:.75rem;font-weight:700;padding:5px 12px;border-radius:5px;cursor:pointer;white-space:nowrap;transition:all .15s;}
.soc-btn:hover{background:rgba(249,160,27,.12);}
.soc-btn.teal{border-color:rgba(0,178,169,.4);color:var(--teal);}
.soc-btn.teal:hover{background:rgba(0,178,169,.12);}
.friend-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid rgba(255,255,255,.05);}
.friend-row:last-child{border-bottom:none;}
.friend-name{font-family:'Barlow Condensed',sans-serif;font-size:.95rem;font-weight:700;flex:1;}
.friend-sub{font-family:'Barlow Condensed',sans-serif;font-size:.72rem;color:rgba(245,240,232,.38);}
.trade-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:8px;margin-bottom:10px;}
.trade-card-opt{border:2px solid rgba(255,255,255,.1);border-radius:8px;padding:7px 4px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(0,20,50,.5);}
.trade-card-opt:hover{border-color:var(--teal);}
.trade-card-opt.sel{border-color:var(--gold);background:rgba(249,160,27,.1);}
.trade-card-opt.dimmed{opacity:.45;}
.incoming-trade{background:rgba(0,0,0,.3);border-radius:8px;padding:12px 14px;margin-bottom:8px;}
.it-from{font-family:'Barlow Condensed',sans-serif;font-size:.78rem;color:rgba(245,240,232,.4);margin-bottom:3px;}
.it-card{font-family:'Barlow Condensed',sans-serif;font-size:1rem;font-weight:700;color:var(--cream);}
.it-actions{display:flex;gap:6px;margin-top:8px;}
</style>
</head>
<body>

<header>
  <div class="logo">Jazz<span>Dex</span></div>
  <div class="hdr-right">
    <div class="hdr-stats">
      <span>CAUGHT <strong id="caught-count">0</strong></span>
      <span>/ <span id="total-count">18</span></span>
    </div>
    <div id="auth-bar" style="display:flex;gap:6px;align-items:center;flex-shrink:0"></div>
    <div class="save-badge" id="save-badge">üíæ saved</div>
  </div>
</header>

<nav>
  <button class="nav-btn active"  onclick="showView('map-view',this)">üó∫ Map</button>
  <button class="nav-btn"         onclick="showView('cards-view',this)">üÉè Cards</button>
  <button class="nav-btn"         onclick="showView('dex-view',this)">üìã JazzDex</button>
  <button class="nav-btn"         onclick="showView('court-view',this)">üèü Court</button>
  <button class="nav-btn"         onclick="showView('faces-view',this)">üì∏ Faces</button>
  <button class="nav-btn"         onclick="showView('custom-view',this)">‚≠ê My Player</button>
  <button class="nav-btn"         onclick="showView('social-view',this)">ü§ù Social</button>
</nav>

<!-- MAP -->
<div id="map-view" class="view active">
  <div class="court-wrap" id="court-map">
    <img src="images/jazz-court.png" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;" alt="Jazz court">
  </div>
  <div class="map-legend">
    <div class="leg-item"><div class="leg-dot" style="background:var(--common)"></div>Common</div>
    <div class="leg-item"><div class="leg-dot" style="background:var(--rare)"></div>Rare</div>
    <div class="leg-item"><div class="leg-dot" style="background:var(--epic)"></div>Epic</div>
    <div class="leg-item"><div class="leg-dot" style="background:var(--legendary)"></div>Legendary</div>
    <span class="map-hint">Players respawn ‚Äî catch multiples!</span>
  </div>
</div>

<!-- CARDS -->
<div id="cards-view" class="view">
  <div class="view-inner">
    <div class="view-title">Player Cards</div>
    <div class="cards-grid" id="cards-grid"></div>
  </div>
</div>

<!-- DEX -->
<div id="dex-view" class="view">
  <div class="view-inner">
    <div class="view-title">JazzDex</div>
    <div class="dex-bar-wrap">
      <div class="dex-track"><div class="dex-fill" id="dex-fill" style="width:0%"></div></div>
      <div class="dex-frac"><span id="dex-n">0</span>/<span id="dex-total">18</span></div>
    </div>
    <div class="dex-grid" id="dex-grid"></div>
  </div>
</div>

<!-- COURT -->
<div id="court-view" class="view">
  <div class="roam-court" id="roam-court">
    <img src="images/jazz-court.png" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0;" alt="Jazz court">
    <canvas id="court-cv"></canvas>
  </div>
  <div class="court-footer">
    <div class="court-footer-top" id="court-footer-top">Catch players to see them roam here!</div>
    <div class="roster-bar" id="roster-bar"></div>
    <div class="roster-hint" id="roster-hint">Tap + to add up to 5 players</div>
  </div>
</div>

<!-- FACES -->
<div id="faces-view" class="view">
  <div class="view-inner">
    <div class="view-title">Upload Player Faces</div>
    <p style="font-family:'Barlow Condensed',sans-serif;font-size:.9rem;color:rgba(245,240,232,.5);margin-bottom:16px;line-height:1.6">Upload a headshot for each player ‚Äî fills their in-game head and card front. Square crops work best.</p>
    <div class="faces-grid" id="faces-grid"></div>
  </div>
</div>

<!-- CUSTOM PLAYER -->
<div id="custom-view" class="view">
  <div class="view-inner">
    <div class="view-title">My Player</div>
    <div class="custom-creator">
      <!-- Live preview area -->
      <div class="custom-preview-area" id="custom-preview-area">
        <div id="custom-preview"></div>
        <div class="cp-live-stats" id="cp-live-stats"></div>
      </div>
      <div class="form-grid">
        <div class="form-field">
          <label>Name</label>
          <input type="text" id="cp-name" placeholder="Your name" maxlength="20">
        </div>
        <div class="form-field">
          <label>Jersey #</label>
          <input type="text" id="cp-num" placeholder="00" maxlength="3">
        </div>
        <div class="form-field">
          <label>PPG</label>
          <input type="number" id="cp-ppg" placeholder="0.0" step="0.1" min="0" max="99">
        </div>
        <div class="form-field">
          <label>APG</label>
          <input type="number" id="cp-apg" placeholder="0.0" step="0.1" min="0" max="99">
        </div>
        <div class="form-field">
          <label>RPG</label>
          <input type="number" id="cp-rpg" placeholder="0.0" step="0.1" min="0" max="99">
        </div>
        <div class="form-field">
          <label>Jersey Color</label>
          <select id="cp-rarity">
            <option value="common">Teal (Common)</option>
            <option value="rare">Purple (Rare)</option>
            <option value="epic">Orange (Epic)</option>
            <option value="legendary">Gold (Legendary)</option>
          </select>
        </div>
      </div>
      <div class="form-grid wide" style="margin-top:12px">
        <div class="form-field">
          <label>Quote / Motto</label>
          <input type="text" id="cp-quote" placeholder="Your catchphrase..." maxlength="60">
        </div>
      </div>
      <label class="face-upload-btn" style="margin-top:12px">
        üì∑ Upload Your Face Photo
        <input type="file" accept="image/*" id="cp-face-input" onchange="loadCustomFace(this)">
      </label>
      <button class="save-player-btn" onclick="saveCustomPlayer()">üíæ SAVE MY PLAYER</button>
      <div class="saved-badge" id="cp-saved">‚úì Player saved!</div>
    </div>
    <!-- Stats panel shown after save -->
    <div id="cp-stats-section"></div>
    <!-- Card preview shown after save -->
    <div class="custom-card-display" id="custom-card-display"></div>
  </div>
</div>

<!-- SOCIAL -->
<div id="social-view" class="view">
  <div class="view-inner">
    <div class="view-title">Social</div>

    <!-- Guest upsell -->
    <div id="guest-upsell" style="display:none;background:linear-gradient(135deg,rgba(249,160,27,.12),rgba(0,178,169,.08));border:1px solid rgba(249,160,27,.25);border-radius:12px;padding:16px 20px;margin-bottom:16px;">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;color:var(--gold);margin-bottom:6px">Playing as Guest</div>
      <p style="font-family:'Barlow Condensed',sans-serif;font-size:.85rem;color:rgba(245,240,232,.6);line-height:1.6;margin-bottom:12px">Sign in or create an account to unlock <strong style="color:var(--teal)">cloud saves</strong>, <strong style="color:var(--teal)">find friends</strong>, and <strong style="color:var(--teal)">trade cards</strong>.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="auth-submit" style="width:auto;padding:8px 20px;font-size:1rem" onclick="openAuthModal('login')">Sign In</button>
        <button class="auth-submit" style="width:auto;padding:8px 20px;font-size:1rem" onclick="openAuthModal('register')">Create Account</button>
      </div>
    </div>

    <!-- Friends list -->
    <div class="social-sec">
      <div class="social-sec-title">ü§ù Friends</div>
      <div id="friends-list"><div class="social-empty">Loading‚Ä¶</div></div>
    </div>

    <!-- Find players -->
    <div class="social-sec">
      <div class="social-sec-title">üîç Find Players</div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input id="user-search-input" type="text" class="auth-input" style="margin-bottom:0;flex:1" placeholder="Search by username‚Ä¶" onkeydown="if(event.key==='Enter')searchUsers()">
        <button class="soc-btn" onclick="searchUsers()">Search</button>
      </div>
      <div id="search-results"></div>
      <div id="suggested-users" style="margin-top:10px"></div>
    </div>

    <!-- Trade: send -->
    <div class="social-sec" id="trade-send-panel" style="display:none">
      <div class="social-sec-title">üîÑ Send Card to <span id="trade-to-name" style="color:var(--teal)"></span></div>
      <p style="font-family:'Barlow Condensed',sans-serif;font-size:.82rem;color:rgba(245,240,232,.45);margin-bottom:12px">Select a card to give. Your count decreases by 1. They receive it immediately ‚Äî no confirmation needed.</p>
      <div class="trade-grid" id="trade-card-grid"></div>
      <div id="trade-send-status" style="font-family:'Barlow Condensed',sans-serif;font-size:.82rem;color:var(--teal);min-height:18px;margin-bottom:8px"></div>
      <div style="display:flex;gap:8px">
        <button id="trade-send-btn" class="auth-submit" style="width:auto;padding:9px 22px;font-size:1rem" disabled onclick="confirmSendCard()">Send Card</button>
        <button class="auth-guest" style="width:auto;padding:9px 18px" onclick="closeTrade()">Cancel</button>
      </div>
    </div>

    <!-- Received cards log -->
    <div class="social-sec">
      <div class="social-sec-title">üì¨ Received Cards</div>
      <div id="received-log"><div class="social-empty">No received cards yet.</div></div>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="modal-overlay" id="auth-modal">
  <div class="catch-modal" style="max-width:360px">
    <button class="modal-close" onclick="closeAuthModal()">‚úï</button>
    <div style="font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:3px;color:var(--gold);margin-bottom:14px">JazzDex Account</div>
    <div class="auth-tab-bar">
      <button class="auth-tab active" id="atab-login"    onclick="switchAuthTab('login')">Sign In</button>
      <button class="auth-tab"        id="atab-register" onclick="switchAuthTab('register')">Create Account</button>
    </div>
    <!-- Login panel -->
    <div id="apanel-login">
      <label class="auth-label">Email</label>
      <input class="auth-input" id="auth-login-email" type="email" placeholder="your@email.com" autocomplete="email">
      <label class="auth-label">Password</label>
      <input class="auth-input" id="auth-login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      <div class="auth-err" id="auth-login-err"></div>
      <button class="auth-submit" onclick="doLogin()">Sign In</button>
      <div class="auth-divider">‚Äî or ‚Äî</div>
      <button class="auth-guest" onclick="doGuest()">Continue as Guest</button>
      <p class="auth-note">Guest progress saves to this device only. Sign in to sync and trade.</p>
    </div>
    <!-- Register panel -->
    <div id="apanel-register" style="display:none">
      <label class="auth-label">Username</label>
      <input class="auth-input" id="auth-reg-name" type="text" placeholder="JazzFan99" maxlength="24" autocomplete="username">
      <label class="auth-label">Email</label>
      <input class="auth-input" id="auth-reg-email" type="email" placeholder="your@email.com" autocomplete="email">
      <label class="auth-label">Password</label>
      <input class="auth-input" id="auth-reg-pass" type="password" placeholder="min 6 characters" autocomplete="new-password">
      <div class="auth-err" id="auth-reg-err"></div>
      <button class="auth-submit" onclick="doRegister()">Create Account</button>
    </div>
  </div>
</div>

<!-- CATCH MODAL -->
<div class="modal-overlay" id="catch-modal">
  <div class="catch-modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div id="modal-body"></div>
  </div>
</div>

<!-- PLAYER PICKER -->
<div class="picker-overlay" id="picker-overlay">
  <div class="picker-modal">
    <button class="picker-close" onclick="closePicker()">‚úï</button>
    <div class="picker-title">Choose a Player</div>
    <div class="picker-sub">Tap to add or remove from court slot</div>
    <div class="picker-grid" id="picker-grid"></div>
  </div>
</div>

<!-- BEAR TOAST -->
<div class="bear-toast" id="bear-toast">üêª JAZZ BEAR UNLOCKED!</div>

<script type="module">
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
import { initializeApp }
  from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getAuth, signInAnonymously, signInWithEmailAndPassword,
         createUserWithEmailAndPassword, updateProfile, signOut,
         onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, getDocs, addDoc,
         updateDoc, deleteDoc, collection, query, where,
         orderBy, limit, serverTimestamp, arrayUnion, increment }
  from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const FB = {
  apiKey:"AIzaSyAnvxjxvAz4tj6FlOziXU8UTIyUWbSSsSo",
  authDomain:"jazzdex.firebaseapp.com",
  projectId:"jazzdex",
  storageBucket:"jazzdex.firebasestorage.app",
  messagingSenderId:"257047661012",
  appId:"1:257047661012:web:33afe587caef2cf391ae41"
};
const app  = initializeApp(FB);
const auth = getAuth(app);
const db   = getFirestore(app);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RARITY / SHIRT COLORS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RC = {common:'#00B2A9',rare:'#7C4DFF',epic:'#FF6D00',legendary:'#F9A01B'};
const SC = {common:'#00868a',rare:'#5533aa',epic:'#aa3300',legendary:'#aa7700'};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPAWN CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RARITY_SPAWN = {
  common:{interval:7000,duration:18000},
  rare:{interval:13000,duration:9000},
  epic:{interval:22000,duration:6000},
  legendary:{interval:40000,duration:3500}
};
const MAX_SPAWNS = 5;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PLAYERS = [
  {id:1, name:'Karl Malone',      short:'Malone',   rarity:'legendary',lastName:'Malone',   era:'1985‚Äì2003',ppg:25.0,apg:3.6, rpg:10.1,blk:1.0, quote:'The Mailman always delivers.',     num:'32'},
  {id:2, name:'John Stockton',    short:'Stockton', rarity:'legendary',lastName:'Stockton', era:'1984‚Äì2003',ppg:13.1,apg:10.5,rpg:2.7, blk:0.2, quote:'Greatest PG of all time.',         num:'12'},
  {id:3, name:'Pete Maravich',    short:'Pistol',   rarity:'epic',     lastName:'Maravich', era:'1974‚Äì1980',ppg:24.4,apg:5.4, rpg:4.2, blk:0.2, quote:'Pistol Pete ‚Äî pure magic.',        num:'7'},
  {id:4, name:'Donovan Mitchell', short:'Spida',    rarity:'epic',     lastName:'Mitchell', era:'2017‚Äì2021',ppg:23.9,apg:4.4, rpg:4.4, blk:0.5, quote:'Spida climbs any wall.',           num:'45'},
  {id:5, name:'Adrian Dantley',   short:'Dantley',  rarity:'epic',     lastName:'Dantley',  era:'1979‚Äì1986',ppg:26.6,apg:2.9, rpg:5.7, blk:0.3, quote:'A scoring machine.',               num:'4'},
  {id:6, name:'Rudy Gobert',      short:'Gobert',   rarity:'rare',     lastName:'Gobert',   era:'2013‚Äì2022',ppg:14.3,apg:1.3, rpg:13.5,blk:2.3, quote:'The Stifle Tower.',                num:'27'},
  {id:7, name:'Darrell Griffith', short:'Griff',    rarity:'rare',     lastName:'Griffith', era:'1980‚Äì1991',ppg:16.2,apg:2.2, rpg:3.6, blk:0.5, quote:'Dr. Dunkenstein takes flight.',    num:'35'},
  {id:8, name:'Andrei Kirilenko', short:'AK-47',    rarity:'rare',     lastName:'Kirilenko',era:'2001‚Äì2011',ppg:12.2,apg:3.2, rpg:6.4, blk:2.2, quote:'AK-47 ‚Äî one of a kind.',           num:'47'},
  {id:9, name:'Mehmet Okur',      short:'Okur',     rarity:'rare',     lastName:'Okur',     era:'2004‚Äì2011',ppg:14.6,apg:1.8, rpg:7.3, blk:1.2, quote:'The Turkish Hammer.',              num:'13'},
  {id:10,name:'Deron Williams',   short:'D-Will',   rarity:'rare',     lastName:'Williams', era:'2005‚Äì2011',ppg:18.8,apg:9.3, rpg:3.7, blk:0.3, quote:'D-Will was something special.',    num:'8'},
  {id:11,name:'Mark Eaton',       short:'Eaton',    rarity:'rare',     lastName:'Eaton',    era:'1982‚Äì1993',ppg:6.0, apg:0.6, rpg:7.9, blk:3.5, quote:'No easy buckets.',                 num:'53'},
  {id:12,name:'Thurl Bailey',     short:'T.Bailey', rarity:'rare',     lastName:'Bailey',   era:'1983‚Äì1991',ppg:13.3,apg:1.3, rpg:6.1, blk:1.6, quote:'Big T ‚Äî heart of gold.',           num:'41'},
  {id:13,name:'Bojan Bogdanovic', short:'Bojan',    rarity:'common',   lastName:'Bogdanovic',era:'2019‚Äì2022',ppg:18.2,apg:2.1,rpg:3.7,blk:0.2,  quote:'Automatic from corner.',           num:'44'},
  {id:14,name:'Carlos Boozer',    short:'Boozer',   rarity:'common',   lastName:'Boozer',   era:'2004‚Äì2010',ppg:16.5,apg:1.8, rpg:9.6, blk:0.6, quote:'Power and finesse combined.',      num:'5'},
  {id:15,name:'Jordan Clarkson',  short:'Clarkson', rarity:'common',   lastName:'Clarkson', era:'2019‚ÄìNow', ppg:17.4,apg:2.5, rpg:3.3, blk:0.2, quote:'Sixth Man energy.',               num:'00'},
  {id:16,name:'Jeff Hornacek',    short:'Hornacek', rarity:'common',   lastName:'Hornacek', era:'1994‚Äì2000',ppg:16.6,apg:4.7, rpg:3.3, blk:0.2, quote:"A clutch shooter's shooter.",     num:'14'},
  {id:17,name:'Joe Ingles',       short:'Ingles',   rarity:'common',   lastName:'Ingles',   era:'2014‚Äì2022',ppg:8.5, apg:3.3, rpg:3.1, blk:0.3, quote:'Aussie wit & threes.',             num:'2'},
  {id:18,name:'Kyle Korver',      short:'Korver',   rarity:'common',   lastName:'Korver',   era:'2007‚Äì2010',ppg:11.5,apg:1.5, rpg:3.0, blk:0.2, quote:'The most dangerous shooter alive.',num:'26'},
];
const BEAR = {id:999,name:'Jazz Bear',short:'Bear',rarity:'legendary',lastName:'Bear',
  era:'1994‚ÄìNow',ppg:0,apg:0,rpg:0,blk:999,quote:'The heart and soul of Delta Center.',num:'üêª',isBear:true};
const RO = {legendary:0,epic:1,rare:2,common:3};
function sortedPlayers(list){
  return [...list].sort((a,b)=>{
    const rd=RO[a.rarity]-RO[b.rarity];
    return rd!==0?rd:(a.lastName||a.name).localeCompare(b.lastName||b.name);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let caught       = new Set();
let cardCounts   = {};      // {id: count}
let cardImages   = {};      // {id: dataURL} ‚Äî card-only photo (separate from face)
let faceImages   = {};      // {id: dataURL} ‚Äî in-game head photo
let activeSpawns = {};
let roamPos      = {};
let roamTimer    = null;
let courtAF      = null;
let currentTarget= null;
let hoopAF       = null;
let courtRoster  = [];
let bearUnlocked = false;
let customPlayer = null;
let customFaceImg= null;
let customCardImg= null;    // separate card image for custom player
let sessionStart = Date.now();
let totalPlayMs  = 0;
let lastSeen     = null;
// Social state
let currentUser  = null;    // Firebase user object
let friends      = [];      // [{uid, displayName, caughtCount, friendedAt}]
let tradeTargetUID  = null;
let tradeTargetName = null;
let tradeSelectedId = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCAL STORAGE ‚Äî always save/load here first
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function lsSave() {
  try {
    const nowMs = totalPlayMs+(Date.now()-sessionStart);
    sessionStart=Date.now(); totalPlayMs=nowMs;
    lastSeen=new Date().toISOString();
  } catch(e){}
}
function lsLoad() {
  try {
   // const g=k=>localStorage.getItem(k);
    const c=g('jd_caught'),cc=g('jd_counts'),f=g('jd_faces'),ci=g('jd_cimgs'),
          r=g('jd_roster'),b=g('jd_bear'),cp=g('jd_custom'),cf=g('jd_cface'),
          ccd=g('jd_ccardimg'),rp=g('jd_roampos'),pt=g('jd_playtime'),ls=g('jd_lastseen');
    if(c)  caught=new Set(JSON.parse(c).map(x=>typeof x==='string'?x:Number(x)));
    if(cc) cardCounts=JSON.parse(cc);
    if(f)  faceImages=JSON.parse(f);
    if(ci) cardImages=JSON.parse(ci);
    if(r)  { const p=JSON.parse(r); courtRoster=p.filter(id=>id==='cp'||id===999||caught.has(id)); }
    if(b)  bearUnlocked=b==='1';
    if(cp) customPlayer=JSON.parse(cp);
    if(cf) customFaceImg=cf||null;
    if(ccd) customCardImg=ccd||null;
    if(rp) roamPos=JSON.parse(rp);
    if(pt) totalPlayMs=parseInt(pt)||0;
    if(ls) lastSeen=ls;
  } catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOUD SAVE / LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function cloudSave() {
  lsSave();
  if (!currentUser||currentUser.isAnonymous) return;
  try {
    await setDoc(doc(db,'saves',currentUser.uid), {
      caught:[...caught].map(Number).filter(n=>!isNaN(n)).concat([...caught].filter(x=>x==='cp'||isNaN(Number(x)))),
      cardCounts, roster:courtRoster, bearUnlocked,
      customPlayer: customPlayer||null,
      totalPlayMs, lastSeen:new Date().toISOString(),
    },{merge:true});
    // Update public profile caughtCount
    await updateDoc(doc(db,'users',currentUser.uid),{
      caughtCount:PLAYERS.filter(p=>caught.has(p.id)).length,
      lastSeen:new Date().toISOString()
    }).catch(()=>{});
    flashSave();
  } catch(e){ console.warn('Cloud save failed',e); }
}
async function cloudLoad(uid) {
  try {
    const snap=await getDoc(doc(db,'saves',uid));
    if(!snap.exists()) return false;
    const d=snap.data();
    const rawCaught=(d.caught||[]);
    caught=new Set(rawCaught.map(x=>{const n=Number(x);return isNaN(n)?x:n;}));
    cardCounts=d.cardCounts||{};
    courtRoster=(d.roster||[]).filter(id=>id==='cp'||id===999||caught.has(id)||caught.has(Number(id)));
    bearUnlocked=d.bearUnlocked||false;
    customPlayer=d.customPlayer||null;
    totalPlayMs=d.totalPlayMs||0;
    lastSeen=d.lastSeen||null;
    return true;
  } catch(e){ return false; }
}

function flashSave(){
  const b=document.getElementById('save-badge');
  if(!b)return; b.style.opacity='1'; b.textContent='‚òÅ saved';
  setTimeout(()=>b.style.opacity='0',2000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
onAuthStateChanged(auth, async user=>{
  currentUser=user;
  renderAuthBar();
  if(!user) return;
  if(user.isAnonymous) return; // guests: local only, no cloud load

  // Named user: load cloud, merge with local
  const loaded=await cloudLoad(user.uid);
  if(loaded){
    updateCounts(); renderCards(); renderDex(); renderFaces();
    if(bearUnlocked&&!caught.has(999)){caught.add(999);cardCounts[999]=1;}
    // Refresh custom view if open
    if(document.getElementById('custom-view').classList.contains('active')) initCustomView();
  }
  // Load friends list
  await loadFriends();
  // Refresh social tab if open
  if(document.getElementById('social-view').classList.contains('active')) renderSocialView();
});

function renderAuthBar(){
  const bar=document.getElementById('auth-bar'); if(!bar) return;
  const u=currentUser;
  if(!u){
    bar.innerHTML=`<button class="auth-btn-sm gold" onclick="openAuthModal('login')">Sign In</button>`;
  } else if(u.isAnonymous){
    bar.innerHTML=`<span style="font-family:'Barlow Condensed',sans-serif;font-size:.72rem;color:rgba(245,240,232,.3)">Guest</span>
      <button class="auth-btn-sm" onclick="openAuthModal('register')">Save Progress</button>`;
  } else {
    const name=u.displayName||u.email||'User';
    bar.innerHTML=`<span style="font-family:'Barlow Condensed',sans-serif;font-size:.75rem;color:rgba(245,240,232,.55)">üë§ ${name}</span>
      <button class="auth-btn-sm" onclick="doSignOut()">Sign Out</button>`;
  }
}

window.openAuthModal = function(tab='login'){
  document.getElementById('auth-modal').classList.add('open');
  switchAuthTab(tab);
  // Clear errors
  ['auth-login-err','auth-reg-err'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.textContent='';
  });
};
window.closeAuthModal = function(){
  document.getElementById('auth-modal').classList.remove('open');
};
window.switchAuthTab = function(tab){
  document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('atab-'+tab)?.classList.add('active');
  document.getElementById('apanel-login').style.display  = tab==='login'   ?'block':'none';
  document.getElementById('apanel-register').style.display = tab==='register'?'block':'none';
};
window.doLogin = async function(){
  const email=document.getElementById('auth-login-email').value.trim();
  const pass =document.getElementById('auth-login-pass').value;
  const err  =document.getElementById('auth-login-err');
  err.textContent='';
  try {
    // If currently anonymous, save local progress before auth switch
    lsSave();
    await signInWithEmailAndPassword(auth,email,pass);
    closeAuthModal();
    showToast('‚úì Signed in!');
  } catch(e){ err.textContent=cleanFirebaseErr(e.message); }
};
window.doRegister = async function(){
  const name =document.getElementById('auth-reg-name').value.trim();
  const email=document.getElementById('auth-reg-email').value.trim();
  const pass =document.getElementById('auth-reg-pass').value;
  const err  =document.getElementById('auth-reg-err');
  err.textContent='';
  if(!name){ err.textContent='Username is required.'; return; }
  try {
    lsSave();
    const cred=await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user,{displayName:name});
    // Write public profile
    await setDoc(doc(db,'users',cred.user.uid),{
      uid:cred.user.uid, displayName:name, email,
      caughtCount:0, joinedAt:serverTimestamp()
    });
    // Upload existing progress
    await cloudSave();
    closeAuthModal();
    showToast('‚úì Account created!');
  } catch(e){ err.textContent=cleanFirebaseErr(e.message); }
};
window.doGuest = async function(){
  try {
    await signInAnonymously(auth);
    closeAuthModal();
  } catch(e){ showToast('Guest sign-in failed: '+e.message); }
};
window.doSignOut = async function(){
  lsSave();
  await signOut(auth);
  renderAuthBar();
  showToast('Signed out.');
};
function cleanFirebaseErr(msg){
  return msg.replace('Firebase: ','').replace(/\(auth\/[^)]+\)/,'').trim();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SOCIAL ‚Äî FRIENDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadFriends(){
  friends=[];
  if(!currentUser||currentUser.isAnonymous) return;
  try {
    const snap=await getDoc(doc(db,'users',currentUser.uid));
    const uids=(snap.data()?.friends)||[];
    for(const uid of uids){
      const p=await getDoc(doc(db,'users',uid));
      if(p.exists()) friends.push({uid,...p.data()});
    }
  } catch(e){}
}

function renderFriendsList(){
  const el=document.getElementById('friends-list'); if(!el) return;
  if(!currentUser||currentUser.isAnonymous){
    el.innerHTML='<div class="social-empty">Sign in to see your friends.</div>'; return;
  }
  if(!friends.length){
    el.innerHTML='<div class="social-empty">No friends yet ‚Äî search for players below!</div>'; return;
  }
  el.innerHTML=friends.map(f=>`
    <div class="friend-row">
      <div>
        <div class="friend-name">${f.displayName}</div>
        <div class="friend-sub">Caught ${f.caughtCount||0}/18</div>
      </div>
      <button class="soc-btn teal" onclick="openTrade('${f.uid}','${f.displayName}')">Send Card</button>
    </div>`).join('');
}

window.searchUsers = async function(){
  const q=document.getElementById('user-search-input')?.value?.trim();
  const res=document.getElementById('search-results'); if(!res) return;
  if(!q){ res.innerHTML=''; return; }
  if(!currentUser||currentUser.isAnonymous){
    res.innerHTML='<div class="social-empty">Sign in to search for players.</div>'; return;
  }
  res.innerHTML='<div class="social-empty">Searching‚Ä¶</div>';
  try {
    const snap=await getDocs(query(
      collection(db,'users'),
      where('displayName','>=',q),
      where('displayName','<=',q+'\uf8ff'),
      limit(8)
    ));
    const myFriendUIDs=friends.map(f=>f.uid);
    const results=snap.docs.filter(d=>d.id!==currentUser.uid);
    if(!results.length){ res.innerHTML='<div class="social-empty">No users found.</div>'; return; }
    res.innerHTML=results.map(d=>{
      const u=d.data();
      const isFriend=myFriendUIDs.includes(d.id);
      return `<div class="user-row">
        <div>
          <div class="user-row-name">${u.displayName}</div>
          <div class="user-row-sub">Caught ${u.caughtCount||0}/18</div>
        </div>
        ${isFriend
          ? `<span class="user-row-sub">Friends ‚úì</span>
             <button class="soc-btn teal" onclick="openTrade('${d.id}','${u.displayName}')">Send Card</button>`
          : `<button class="soc-btn" onclick="addFriend('${d.id}','${u.displayName}')">Add Friend</button>`}
      </div>`;
    }).join('');
  } catch(e){ res.innerHTML=`<div class="social-empty">Search failed ‚Äî try again.</div>`; }
};

// Load suggested players (most active/recent)
async function loadSuggested(){
  const el=document.getElementById('suggested-users'); if(!el) return;
  if(!currentUser||currentUser.isAnonymous){ el.innerHTML=''; return; }
  try {
    const snap=await getDocs(query(
      collection(db,'users'),
      orderBy('caughtCount','desc'),
      limit(5)
    ));
    const myFriendUIDs=friends.map(f=>f.uid);
    const results=snap.docs.filter(d=>d.id!==currentUser.uid).slice(0,4);
    if(!results.length){ el.innerHTML=''; return; }
    el.innerHTML=`<div style="font-family:'Barlow Condensed',sans-serif;font-size:.75rem;color:rgba(245,240,232,.35);margin-bottom:6px;letter-spacing:1px;text-transform:uppercase">Suggested Players</div>`
      +results.map(d=>{
        const u=d.data();
        const isFriend=myFriendUIDs.includes(d.id);
        return `<div class="user-row">
          <div>
            <div class="user-row-name">${u.displayName}</div>
            <div class="user-row-sub">Caught ${u.caughtCount||0}/18</div>
          </div>
          ${isFriend
            ? `<span class="user-row-sub">Friends ‚úì</span>
               <button class="soc-btn teal" onclick="openTrade('${d.id}','${u.displayName}')">Send Card</button>`
            : `<button class="soc-btn" onclick="addFriend('${d.id}','${u.displayName}')">Add Friend</button>`}
        </div>`;
      }).join('');
  } catch(e){ el.innerHTML=''; }
}

window.addFriend = async function(uid, name){
  if(!currentUser||currentUser.isAnonymous){ openAuthModal('register'); return; }
  try {
    // Add to both users' friend lists
    await updateDoc(doc(db,'users',currentUser.uid),{friends:arrayUnion(uid)});
    await updateDoc(doc(db,'users',uid),{friends:arrayUnion(currentUser.uid)});
    await loadFriends();
    renderFriendsList();
    // Refresh search results
    await searchUsers();
    showToast(`‚úì ${name} added as friend!`);
  } catch(e){ showToast('Failed: '+e.message); }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SOCIAL ‚Äî CARD TRADING (send only, instant)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openTrade = function(uid, name){
  if(!currentUser||currentUser.isAnonymous){ openAuthModal('register'); return; }
  tradeTargetUID=uid; tradeTargetName=name; tradeSelectedId=null;
  document.getElementById('trade-send-panel').style.display='block';
  document.getElementById('trade-to-name').textContent=name;
  document.getElementById('trade-send-btn').disabled=true;
  document.getElementById('trade-send-status').textContent='';
  renderTradeCardGrid();
  // Scroll to trade panel
  document.getElementById('trade-send-panel').scrollIntoView({behavior:'smooth',block:'nearest'});
};
window.closeTrade = function(){
  tradeTargetUID=null; tradeTargetName=null; tradeSelectedId=null;
  document.getElementById('trade-send-panel').style.display='none';
};

function renderTradeCardGrid(){
  const grid=document.getElementById('trade-card-grid'); if(!grid) return;
  // All cards the user has (caught players + bear + custom)
  const opts=[];
  sortedPlayers(PLAYERS.filter(p=>caught.has(p.id))).forEach(p=>opts.push(p));
  if(bearUnlocked&&caught.has(999)) opts.push(BEAR);
  if(customPlayer) opts.push(customPlayer);

  if(!opts.length){ grid.innerHTML='<div class="social-empty">No cards to send.</div>'; return; }
  grid.innerHTML=opts.map(p=>{
    const cnt=cardCounts[p.id]||1;
    const sel=tradeSelectedId===p.id;
    return `<div class="trade-card-opt ${sel?'sel':''}" onclick="selectTradeCard(${JSON.stringify(p.id)})">
      ${buildChar(p,34)}
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:.6rem;font-weight:700;margin-top:2px">${p.short}</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:.75rem;color:var(--gold)">√ó${cnt}</div>
    </div>`;
  }).join('');
}

window.selectTradeCard = function(id){
  tradeSelectedId=id;
  renderTradeCardGrid();
  document.getElementById('trade-send-btn').disabled=false;
  document.getElementById('trade-send-status').textContent='';
};

window.confirmSendCard = async function(){
  if(!tradeSelectedId||!tradeTargetUID||!currentUser) return;
  const btn=document.getElementById('trade-send-btn');
  const status=document.getElementById('trade-send-status');
  btn.disabled=true; status.textContent='Sending‚Ä¶';

  // Check if we have the card
  const cnt=cardCounts[tradeSelectedId]||0;
  if(cnt<1){ status.textContent='You don\'t have this card!'; btn.disabled=false; return; }

  try {
    // Decrement sender
    cardCounts[tradeSelectedId]=Math.max(0,cnt-1);
    if(cardCounts[tradeSelectedId]===0){
      delete cardCounts[tradeSelectedId];
      caught.delete(tradeSelectedId);
    }

    // Write transfer record ‚Äî receiver doc
    const cardObj=tradeSelectedId===999?BEAR
      :tradeSelectedId==='cp'?{...customPlayer,isSentCustom:true}
      :PLAYERS.find(p=>p.id===tradeSelectedId);

    await addDoc(collection(db,'transfers'),{
      fromUID:currentUser.uid,
      fromName:currentUser.displayName||'Unknown',
      toUID:tradeTargetUID,
      toName:tradeTargetName,
      cardId:tradeSelectedId,
      cardName:cardObj?.name||'Unknown',
      cardRarity:cardObj?.rarity||'common',
      sentAt:serverTimestamp(),
    });

    // Add card to receiver's Firestore save (increment)
    const receiverSave=doc(db,'saves',tradeTargetUID);
    const rSnap=await getDoc(receiverSave);
    if(rSnap.exists()){
      const rd=rSnap.data();
      const rCounts={...rd.cardCounts||{}};
      const rCaught=[...(rd.caught||[])];
      const key=String(tradeSelectedId);
      rCounts[key]=(rCounts[key]||0)+1;
      if(!rCaught.includes(tradeSelectedId)&&!rCaught.includes(key)) rCaught.push(tradeSelectedId);
      await updateDoc(receiverSave,{cardCounts:rCounts,caught:rCaught});
    } else {
      await setDoc(receiverSave,{
        caught:[tradeSelectedId], cardCounts:{[String(tradeSelectedId)]:1}
      },{merge:true});
    }

    await cloudSave();
    updateCounts(); renderCards();
    status.textContent=`‚úì ${cardObj?.name} sent to ${tradeTargetName}!`;
    tradeSelectedId=null; renderTradeCardGrid();
    showToast(`üèÄ Card sent to ${tradeTargetName}!`);
    await loadReceivedCards();
  } catch(e){ status.textContent='Failed: '+e.message; btn.disabled=false; }
};

async function loadReceivedCards(){
  const el=document.getElementById('received-log'); if(!el) return;
  if(!currentUser||currentUser.isAnonymous){
    el.innerHTML='<div class="social-empty">Sign in to see received cards.</div>'; return;
  }
  try {
    const snap=await getDocs(query(
      collection(db,'transfers'),
      where('toUID','==',currentUser.uid),
      orderBy('sentAt','desc'), limit(10)
    ));
    if(snap.empty){ el.innerHTML='<div class="social-empty">No received cards yet.</div>'; return; }
    el.innerHTML=snap.docs.map(d=>{
      const t=d.data();
      const ts=t.sentAt?.toDate?.()?.toLocaleDateString('en-US')||'Recently';
      return `<div class="incoming-trade">
        <div class="it-from">From ${t.fromName} ¬∑ ${ts}</div>
        <div class="it-card" style="color:${RC[t.cardRarity]||'#fff'}">${t.cardName}</div>
      </div>`;
    }).join('');
  } catch(e){ el.innerHTML='<div class="social-empty">Could not load history.</div>'; }
}

function renderSocialView(){
  renderFriendsList();
  loadSuggested();
  loadReceivedCards();
  // Show/hide guest upsell
  const upsell=document.getElementById('guest-upsell');
  if(upsell) upsell.style.display=(!currentUser||currentUser.isAnonymous)?'block':'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg,dur=3200){
  let t=document.getElementById('game-toast');
  if(!t){t=document.createElement('div');t.id='game-toast';document.body.appendChild(t);}
  t.textContent=msg; t.classList.add('show');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),dur);
}
window.showToast=showToast;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARACTER SVG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildChar(p,size=56){
  const shirt=SC[p.rarity]||'#00868a';
  const glow=RC[p.rarity]||'#00B2A9';
  const rawId=p.id;
  const face=p.isBear?null:(p.isCustom?customFaceImg:faceImages[p.id]||null);
  const bobDur=(1.4+(String(p.id).charCodeAt(0)%5)*0.18)+'s';
  const headFill=face?'transparent':(p.isBear?'#8B4513':'#dfc090');
  const bearFace=p.isBear?`
    <circle cx="17" cy="7"  r="5" fill="#6B3410"/><circle cx="39" cy="7"  r="5" fill="#6B3410"/>
    <circle cx="17" cy="7"  r="3" fill="#8B4513"/><circle cx="39" cy="7"  r="3" fill="#8B4513"/>
    <ellipse cx="28" cy="22" rx="7" ry="5" fill="#c8956a"/>
    <ellipse cx="28" cy="19" rx="3" ry="2" fill="#1a0a00"/>
    <circle cx="23" cy="15" r="2.5" fill="#1a0a00"/><circle cx="33" cy="15" r="2.5" fill="#1a0a00"/>
    <circle cx="23.7" cy="14.2" r=".8" fill="white"/><circle cx="33.7" cy="14.2" r=".8" fill="white"/>
    <path d="M24 23 Q28 27 32 23" stroke="#5a2a10" stroke-width="1.2" fill="none" stroke-linecap="round"/>`:' ';
  const faceEl=face
    ?`<image href="${face}" x="13" y="3" width="30" height="30" clip-path="url(#hc${rawId})"/>`
    :(p.isBear?bearFace:'');
  return `<svg width="${size}" height="${Math.round(size*1.07)}" viewBox="0 0 56 60" xmlns="http://www.w3.org/2000/svg" style="overflow:visible;display:block">
  <defs><clipPath id="hc${rawId}"><circle cx="28" cy="18" r="15"/></clipPath></defs>
  <g style="animation:chbob${rawId} ${bobDur} ease-in-out infinite">
    <style>@keyframes chbob${rawId}{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}</style>
    <ellipse cx="20" cy="59" rx="7" ry="2.8" fill="#111"/>
    <ellipse cx="36" cy="59" rx="7" ry="2.8" fill="#111"/>
    <rect x="16" y="46" width="9" height="14" rx="4" fill="${shirt}" opacity=".85"/>
    <rect x="31" y="46" width="9" height="14" rx="4" fill="${shirt}" opacity=".85"/>
    <rect x="13" y="29" width="30" height="20" rx="7" fill="${shirt}"/>
    <text x="28" y="43" text-anchor="middle" font-size="${p.isBear?9:7}" font-family="Arial Black,sans-serif" font-weight="900" fill="rgba(255,255,255,.88)">${p.num}</text>
    <rect x="4"  y="30" width="11" height="7" rx="3.5" fill="${shirt}" opacity=".9"/>
    <rect x="41" y="30" width="11" height="7" rx="3.5" fill="${shirt}" opacity=".9"/>
    <rect x="24" y="26" width="8" height="6" rx="3" fill="${headFill}"/>
    <g style="animation:hdsway${rawId} ${bobDur} ease-in-out infinite;transform-origin:28px 18px">
      <style>@keyframes hdsway${rawId}{0%,100%{transform:rotate(-2.5deg)}50%{transform:rotate(2.5deg)}}</style>
      <circle cx="28" cy="18" r="15" fill="${headFill}"/>
      ${faceEl}
      <circle cx="28" cy="18" r="15" fill="none" stroke="rgba(0,0,0,.12)" stroke-width="1"/>
      ${!p.isBear?`<path d="M13 11 Q28 2 43 11" fill="${shirt}" opacity=".55"/>`:''}
    </g>
    ${p.rarity==='legendary'?`<text x="47" y="7" font-size="8" fill="${glow}">‚òÖ</text>`:''}
    ${p.rarity==='epic'?`<text x="47" y="7" font-size="7" fill="${glow}">‚óÜ</text>`:''}
  </g>
</svg>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FACES PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFaces(){
  const grid=document.getElementById('faces-grid'); if(!grid) return;
  grid.innerHTML=PLAYERS.map(p=>{
    const col=RC[p.rarity];
    const has=!!faceImages[p.id];
    return `<div class="face-slot" style="border-color:${col}55">
      <label>
        <div class="face-preview" id="fp-${p.id}">${has?`<img src="${faceImages[p.id]}"/>`:'üì∑'}</div>
        <div class="face-pname">${p.short}</div>
        <div class="face-sub" style="color:${col}">${p.rarity}</div>
        <input type="file" accept="image/*" onchange="loadFace(${p.id},this)">
      </label>
    </div>`;
  }).join('');
}
window.loadFace=function(id,input){
  const file=input.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=e=>{
    faceImages[id]=e.target.result;
    const prev=document.getElementById('fp-'+id);
    if(prev) prev.innerHTML=`<img src="${e.target.result}"/>`;
    cloudSave();
    if(document.getElementById('cards-view').classList.contains('active')) renderCards();
    if(document.getElementById('dex-view').classList.contains('active'))   renderDex();
    if(document.getElementById('court-view').classList.contains('active')) rebuildRoamers();
    const mc=document.getElementById('modal-char');
    if(mc&&currentTarget&&currentTarget.id===id) mc.innerHTML=buildChar(currentTarget,68);
    const sb=document.querySelector(`.spawn-char[data-id="${id}"] .char-body`);
    if(sb) sb.innerHTML=buildChar(PLAYERS.find(pl=>pl.id===id),50);
  };
  r.readAsDataURL(file);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CUSTOM PLAYER
// Custom player is a card only ‚Äî it does NOT spawn
// on the map or appear on the court (intentional).
// It shows in Cards view and can be traded.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.loadCustomFace=function(input){
  const file=input.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=e=>{ customFaceImg=e.target.result; refreshCustomPreview(); };
  r.readAsDataURL(file);
};
window.loadCustomCardImg=function(input){
  const file=input.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=e=>{ customCardImg=e.target.result; renderCustomCard(); };
  r.readAsDataURL(file);
};
function getCustomFakePlayer(){
  return {
    id:'cp',
    name:document.getElementById('cp-name')?.value||'My Player',
    short:(document.getElementById('cp-name')?.value||'My Player').split(' ')[0],
    rarity:document.getElementById('cp-rarity')?.value||'common',
    num:document.getElementById('cp-num')?.value||'00',
    isCustom:true
  };
}
function refreshCustomPreview(){
  const preview=document.getElementById('custom-preview'); if(!preview) return;
  preview.innerHTML=buildChar(getCustomFakePlayer(),80);
  const ppg=document.getElementById('cp-ppg')?.value||'‚Äî';
  const apg=document.getElementById('cp-apg')?.value||'‚Äî';
  const rpg=document.getElementById('cp-rpg')?.value||'‚Äî';
  const ls=document.getElementById('cp-live-stats');
  if(ls) ls.innerHTML=`<div>PPG <span>${ppg}</span></div><div>APG <span>${apg}</span></div><div>RPG <span>${rpg}</span></div>`;
}
window.refreshCustomPreview=refreshCustomPreview;
window.saveCustomPlayer=function(){
  const name =document.getElementById('cp-name')?.value?.trim()||'My Player';
  const num  =document.getElementById('cp-num')?.value?.trim()||'00';
  const ppg  =parseFloat(document.getElementById('cp-ppg')?.value)||0;
  const apg  =parseFloat(document.getElementById('cp-apg')?.value)||0;
  const rpg  =parseFloat(document.getElementById('cp-rpg')?.value)||0;
  const rarity=document.getElementById('cp-rarity')?.value||'common';
  const quote=document.getElementById('cp-quote')?.value?.trim()||'Built different.';
  const now  =new Date();
  const existing=customPlayer; // preserve joinedISO if re-saving
  customPlayer={
    id:'cp',name,short:name.split(' ')[0]||name,rarity,
    era:`${now.getFullYear()}‚ÄìNow`,lastName:name.split(' ').pop(),
    ppg,apg,rpg,blk:0,quote,num,isCustom:true,
    joinedISO:existing?.joinedISO||now.toISOString(),
    joinedDisplay:existing?.joinedDisplay||fmtDateNice(now.toISOString()),
  };
  // Also give them the card
  if(!cardCounts['cp']) cardCounts['cp']=1;
  cloudSave();
  const badge=document.getElementById('cp-saved');
  if(badge){badge.style.display='block';setTimeout(()=>badge.style.display='none',2500);}
  renderCustomCard();
  renderCustomStats();
  renderCards(); // update cards view
};
function fmtDuration(ms){
  const h=Math.floor(ms/3600000),m=Math.floor((ms%3600000)/60000);
  return h>0?`${h}h ${m}m`:`${m}m`;
}
function fmtDateNice(iso){
  if(!iso) return '‚Äî';
  const d=new Date(iso);
  const day=d.getDate();
  const sfx=day===1||day===21||day===31?'st':day===2||day===22?'nd':day===3||day===23?'rd':'th';
  const mo=d.toLocaleDateString('en-US',{month:'long'});
  const yr=d.getFullYear();
  return `${mo} ${day}${sfx}, ${yr}`;
}
function renderCustomStats(){
  const sec=document.getElementById('cp-stats-section'); if(!sec) return;
  if(!customPlayer){sec.innerHTML='';return;}
  const playtime=fmtDuration(totalPlayMs+(Date.now()-sessionStart));
  const lsDisp=lastSeen?fmtDateNice(lastSeen):'This session';
  const joined=fmtDateNice(customPlayer.joinedISO||customPlayer.joinedDisplay);
  // My player stats: NO "when traded" or "friends since" ‚Äî those only show on others' cards
  sec.innerHTML=`<div class="cp-stats-panel" style="max-width:520px;margin:16px auto 0">
    <h4>üìä My Player Stats</h4>
    <div class="cp-stat-row"><span class="cp-stat-label">Joined</span><span class="cp-stat-val">${joined}</span></div>
    <div class="cp-stat-row"><span class="cp-stat-label">Time Played</span><span class="cp-stat-val">${playtime}</span></div>
    <div class="cp-stat-row"><span class="cp-stat-label">Last Active</span><span class="cp-stat-val">${lsDisp}</span></div>
    <div class="cp-stat-row"><span class="cp-stat-label">Cards Caught</span><span class="cp-stat-val">${caught.size}</span></div>
  </div>`;
}
function renderCustomCard(){
  const area=document.getElementById('custom-card-display'); if(!area) return;
  if(!customPlayer){area.innerHTML='';return;}
  const count=cardCounts['cp']||1;
  area.innerHTML=`
    <div style="font-family:'Barlow Condensed',sans-serif;font-size:.78rem;color:rgba(245,240,232,.35);text-align:center;margin:12px 0 8px;letter-spacing:1px">YOUR CARD ‚Äî tap to flip</div>
    <label class="face-upload-btn" style="max-width:520px;margin:0 auto 12px;display:flex">
      üñº Upload Card Photo (separate from face)
      <input type="file" accept="image/*" onchange="loadCustomCardImg(this)" style="display:none">
    </label>
    <div class="cards-grid" style="max-width:220px;margin:0 auto">${buildCardHTML(customPlayer,count,true)}</div>`;
}
function initCustomView(){
  if(customPlayer){
    document.getElementById('cp-name').value   =customPlayer.name||'';
    document.getElementById('cp-num').value    =customPlayer.num||'';
    document.getElementById('cp-ppg').value    =customPlayer.ppg||'';
    document.getElementById('cp-apg').value    =customPlayer.apg||'';
    document.getElementById('cp-rpg').value    =customPlayer.rpg||'';
    document.getElementById('cp-rarity').value =customPlayer.rarity||'common';
    document.getElementById('cp-quote').value  =customPlayer.quote||'';
  }
  refreshCustomPreview(); renderCustomCard(); renderCustomStats();
  ['cp-name','cp-num','cp-rarity','cp-ppg','cp-apg','cp-rpg'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.removeEventListener('input',refreshCustomPreview); el.addEventListener('input',refreshCustomPreview); }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BEAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkBearUnlock(){
  if(bearUnlocked) return;
  if(!PLAYERS.every(p=>caught.has(p.id))) return;
  bearUnlocked=true; caught.add(999); cardCounts[999]=1;
  cloudSave(); showBearToast(); scheduleBear();
}
function showBearToast(){
  const t=document.getElementById('bear-toast'); if(!t) return;
  t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),4500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPAWN SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function scheduleAll(){
  PLAYERS.forEach(p=>{
    const delay=Math.random()*RARITY_SPAWN[p.rarity].interval*0.7;
    setTimeout(()=>spawnLoop(p),delay);
  });
}
function scheduleBear(){ spawnLoop(BEAR); }
function spawnLoop(p){
  if(!activeSpawns[p.id]) trySpawn(p);
  const cfg=p.isBear?RARITY_SPAWN.legendary:RARITY_SPAWN[p.rarity];
  const next=cfg.interval*(0.8+Math.random()*0.6);
  setTimeout(()=>spawnLoop(p),cfg.duration+next);
}
function trySpawn(p){
  if(p.isBear&&!bearUnlocked) return;
  if(Object.keys(activeSpawns).length>=MAX_SPAWNS) return;
  if(activeSpawns[p.id]) return;
  const cfg=p.isBear?RARITY_SPAWN.legendary:RARITY_SPAWN[p.rarity];
  const glow=RC[p.rarity];
  const court=document.getElementById('court-map');
  let x=12+Math.random()*76, y=14+Math.random()*72;
  const wrap=document.createElement('div');
  wrap.className='spawn-char'; wrap.dataset.id=p.id;
  wrap.style.cssText=`left:${x}%;top:${y}%;filter:drop-shadow(0 0 ${p.rarity==='legendary'?'12':'6'}px ${glow})`;
  const body=document.createElement('div'); body.className='char-body';
  body.innerHTML=buildChar(p,50);
  const shadow=document.createElement('div'); shadow.className='char-shadow';
  const tag=document.createElement('div'); tag.className='char-tag';
  tag.style.color=glow;
  tag.textContent=p.isBear?'???':p.short;
  body.appendChild(shadow); wrap.appendChild(body); wrap.appendChild(tag);
  court.appendChild(wrap);
  requestAnimationFrame(()=>wrap.classList.add('popin'));
  wrap.addEventListener('click',()=>openCatch(p.id,p.isBear));
  const roamId=setInterval(()=>{
    if(!activeSpawns[p.id]) return;
    x=Math.max(8,Math.min(92,x+(Math.random()-.5)*10));
    y=Math.max(10,Math.min(88,y+(Math.random()-.5)*10));
    wrap.style.left=x+'%'; wrap.style.top=y+'%';
  },3200);
  const despawnId=setTimeout(()=>doDeSpawn(p.id),cfg.duration);
  activeSpawns[p.id]={el:wrap,roamId,despawnId};
}
function doDeSpawn(id){
  const s=activeSpawns[id]; if(!s) return;
  clearInterval(s.roamId); clearTimeout(s.despawnId);
  s.el.classList.add('popout');
  setTimeout(()=>s.el.remove(),350);
  delete activeSpawns[id];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CATCH MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCatch(id,isBear=false){
  currentTarget=isBear?BEAR:PLAYERS.find(p=>p.id===id);
  const p=currentTarget;
  const pips=[0,1,2].map(i=>`<div class="shot-pip pending" id="sp${i}">üèÄ</div>`).join('');
  document.getElementById('modal-body').innerHTML=`
    <div class="modal-header">
      <div class="modal-char" id="modal-char">${buildChar(p,68)}</div>
      <div class="modal-info">
        <div class="modal-name">${p.isBear?'???':p.name}</div>
        <span class="modal-rbadge rarity-${p.rarity}">${p.isBear?'MYSTERY':p.rarity.toUpperCase()}</span>
      </div>
    </div>
    <div class="hoop-section">
      <div class="hoop-title">MAKE A BASKET ‚Äî 3 chances, first make catches!</div>
      <div class="shot-row">${pips}</div>
      <canvas id="hoop-cv" width="380" height="150"></canvas>
      <button class="throw-btn" id="throw-btn" onclick="doThrow()">üèÄ THROW</button>
    </div>
    <div class="fail-msg" id="fail-msg">üòì All 3 missed ‚Äî they got away!</div>
    <div class="success-screen" id="success-screen">
      <span class="burst">${p.isBear?'üêª':'üéâ'}</span>
      <h3>${p.isBear?'JAZZ BEAR!':'CAUGHT!'}</h3>
      <p>${p.isBear?'The legend himself is in your JazzDex!':p.name+' added to your JazzDex!'}</p>
    </div>`;
  document.getElementById('catch-modal').classList.add('open');
  initHoop();
}
window.openCatch=openCatch;

function initHoop(){
  const canvas=document.getElementById('hoop-cv'); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height;
  const hoopX=W*.75,hoopY=H*.30,rimR=20,ballX=W*.14,ballY=H*.84;
  const sweetW=22;
  const AIM_SPEEDS={common:.016,rare:.026,epic:.036,legendary:.050};
  const speed=AIM_SPEEDS[currentTarget?.rarity]||.025;
  let aimAngle=0,phase='aim',flyT=0,flyScatter=0,swish=0,shotsDone=0;
  function scatter(){return Math.sin(aimAngle)*58;}
  function arcPt(t,sc){
    const tx=hoopX+sc,cpX=(ballX+tx)*.5,cpY=Math.min(ballY,hoopY)-H*.55;
    return{bx:(1-t)*(1-t)*ballX+2*(1-t)*t*cpX+t*t*tx,by:(1-t)*(1-t)*ballY+2*(1-t)*t*cpY+t*t*hoopY};
  }
  function drawBall(x,y,r=11){
    const g=ctx.createRadialGradient(x-r*.35,y-r*.35,r*.1,x,y,r);
    g.addColorStop(0,'#ffb347');g.addColorStop(1,'#c84800');
    ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.3)';ctx.lineWidth=1.2;
    ctx.beginPath();ctx.arc(x,y,r,-.5,.5);ctx.stroke();
    ctx.beginPath();ctx.arc(x,y,r,Math.PI-.5,Math.PI+.5);ctx.stroke();
  }
  function drawHoop(){
    ctx.fillStyle='#e0d8c0';ctx.fillRect(hoopX+rimR+3,hoopY-28,7,50);
    ctx.strokeStyle='#bbb';ctx.lineWidth=1;ctx.strokeRect(hoopX+rimR+3,hoopY-28,7,50);
    ctx.strokeStyle='rgba(255,255,255,.4)';ctx.lineWidth=1;
    for(let i=0;i<=4;i++){const nx=hoopX-rimR+(rimR*2/4)*i;ctx.beginPath();ctx.moveTo(nx,hoopY+4);ctx.lineTo(hoopX+(nx-hoopX)*.4,hoopY+26);ctx.stroke();}
    ctx.beginPath();ctx.moveTo(hoopX-rimR*.5,hoopY+26);ctx.lineTo(hoopX+rimR*.5,hoopY+26);ctx.stroke();
    ctx.strokeStyle='#E05500';ctx.lineWidth=4.5;
    ctx.beginPath();ctx.ellipse(hoopX,hoopY,rimR,5,0,0,Math.PI*2);ctx.stroke();
  }
  function frame(){
    ctx.clearRect(0,0,W,H);drawHoop();
    if(swish>0){ctx.globalAlpha=swish*.45;ctx.fillStyle='#F9A01B';ctx.beginPath();ctx.arc(hoopX,hoopY,rimR+16,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;swish=Math.max(0,swish-.06);}
    if(phase==='aim'){
      aimAngle+=speed;
      const sc=scatter(),inZone=Math.abs(sc)<sweetW;
      ctx.save();ctx.setLineDash([5,5]);
      ctx.strokeStyle=inZone?'rgba(249,160,27,.95)':'rgba(255,255,255,.3)';
      ctx.lineWidth=inZone?2.4:1.5;
      ctx.beginPath();for(let i=0;i<=40;i++){const{bx,by}=arcPt(i/40,sc);i===0?ctx.moveTo(bx,by):ctx.lineTo(bx,by);}
      ctx.stroke();ctx.setLineDash([]);ctx.restore();
      if(inZone){ctx.strokeStyle='rgba(249,160,27,.5)';ctx.lineWidth=3;ctx.beginPath();ctx.ellipse(hoopX,hoopY,rimR+7,8,0,0,Math.PI*2);ctx.stroke();}
      drawBall(ballX,ballY);hoopAF=requestAnimationFrame(frame);
    } else if(phase==='fly'){
      flyT+=.032;const{bx,by}=arcPt(flyT,flyScatter);drawBall(bx,by);
      if(flyT<1)hoopAF=requestAnimationFrame(frame);else resolveShot(Math.abs(flyScatter)<sweetW);
    } else {drawBall(ballX,ballY);hoopAF=requestAnimationFrame(frame);}
  }
  function resolveShot(made){
    const pip=document.getElementById('sp'+shotsDone);shotsDone++;
    if(made){
      if(pip){pip.classList.remove('pending');pip.classList.add('made');pip.textContent='‚úì';}
      swish=1;cancelAnimationFrame(hoopAF);
      ctx.clearRect(0,0,W,H);drawHoop();ctx.globalAlpha=.4;ctx.fillStyle='#F9A01B';ctx.beginPath();ctx.arc(hoopX,hoopY,rimR+16,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
      document.getElementById('throw-btn').disabled=true;
      setTimeout(autoCatch,600);
    } else {
      if(pip){pip.classList.remove('pending');pip.classList.add('miss');pip.textContent='‚úó';}
      if(shotsDone>=3){
        cancelAnimationFrame(hoopAF);document.getElementById('throw-btn').disabled=true;
        setTimeout(()=>{document.getElementById('fail-msg').style.display='block';setTimeout(closeModal,1800);},300);
      } else {phase='between';hoopAF=requestAnimationFrame(frame);setTimeout(()=>{phase='aim';},500);}
    }
  }
  function autoCatch(){
    const p=currentTarget; if(!p) return;
    caught.add(p.id); cardCounts[p.id]=(cardCounts[p.id]||0)+1;
    updateCounts(); doDeSpawn(p.id); cloudSave();
    if(!p.isBear) checkBearUnlock();
    if(hoopAF) cancelAnimationFrame(hoopAF);
    document.getElementById('success-screen').style.display='block';
    setTimeout(closeModal,1900);
    if(document.getElementById('court-view').classList.contains('active')) rebuildRoamers();
    if(document.getElementById('cards-view').classList.contains('active')) renderCards();
    updateMapMissingBanner();
  }
  window._doThrow=()=>{if(phase!=='aim')return;flyScatter=scatter();flyT=0;phase='fly';};
  hoopAF=requestAnimationFrame(frame);
}
window.doThrow=function(){if(window._doThrow)window._doThrow();};
function closeModal(){
  if(hoopAF)cancelAnimationFrame(hoopAF);
  document.getElementById('catch-modal').classList.remove('open');
  window._doThrow=null;currentTarget=null;
}
window.closeModal=closeModal;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COUNTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateCounts(){
  const unique=PLAYERS.filter(p=>caught.has(p.id)).length;
  document.getElementById('caught-count').textContent=unique;
  const dn=document.getElementById('dex-n');if(dn)dn.textContent=unique;
  const df=document.getElementById('dex-fill');if(df)df.style.width=(unique/PLAYERS.length*100)+'%';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARDS
// buildCardHTML(p, count, isOwnCustom)
// isOwnCustom=true ‚Üí omit "When Traded"/"Friends Since"
// isOwnCustom=false ‚Üí show those fields if present
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildCardHTML(p, count, isOwnCustom=false){
  // Card photo: custom players use customCardImg, regular use cardImages[id], fallback to faceImages
  const cardPhoto = p.isCustom
    ? (customCardImg||customFaceImg||null)
    : (cardImages[p.id]||faceImages[p.id]||null);

  const frontFace=cardPhoto
    ?`<div class="card-face card-front">
         <img class="card-front-img" src="${cardPhoto}" alt="${p.name}"/>
         <div class="card-jersey-badge">#${p.num}</div>
         <div class="card-front-overlay">
           <div class="card-pname">${p.name}</div>
           <span class="card-rbadge rarity-${p.rarity}">${p.rarity}</span>
         </div>
       </div>`
    :`<div class="card-face card-front">
         <div class="card-front-noimg">
           <div class="card-char">${buildChar(p,70)}</div>
           <div class="card-pname">${p.name}</div>
           <div class="card-era">${p.era}</div>
           <span class="card-rbadge rarity-${p.rarity}" style="margin-top:2px">${p.rarity}</span>
         </div>
         <div class="card-jersey-badge">#${p.num}</div>
       </div>`;

  // Custom card back: show joined date with full day.
  // "When Traded" and "Friends Since" only show on cards received from others, NOT your own.
  const customRows = p.isCustom
    ? `<div class="srow" style="grid-column:1/-1"><span class="sl">Joined</span><span class="sv" style="font-size:.73rem">${p.joinedDisplay||fmtDateNice(p.joinedISO)||'‚Äî'}</span></div>`
      + (!isOwnCustom && p.tradedAt ? `<div class="srow" style="grid-column:1/-1"><span class="sl">Traded</span><span class="sv" style="font-size:.73rem">${fmtDateNice(p.tradedAt)}</span></div>` : '')
      + (!isOwnCustom && p.fromName ? `<div class="srow" style="grid-column:1/-1"><span class="sl">From</span><span class="sv" style="font-size:.73rem">${p.fromName}</span></div>` : '')
    : '';

  return `<div class="card-flip-wrap" data-r="${p.rarity}" onclick="this.classList.toggle('flipped')">
    <div class="card-count-badge">√ó${count}</div>
    <div class="card-inner">
      ${frontFace}
      <div class="card-face card-back">
        <div class="card-back-inner">
          <div class="card-back-num">#${String(p.id).padStart(3,'0')} ¬∑ ${p.rarity.toUpperCase()}</div>
          <div class="card-back-name">${p.name}</div>
          <div class="card-back-era">${p.era}</div>
          <div class="card-back-stats">
            <div class="srow"><span class="sl">PPG</span><span class="sv">${p.ppg}</span></div>
            <div class="srow"><span class="sl">APG</span><span class="sv">${p.apg}</span></div>
            <div class="srow"><span class="sl">RPG</span><span class="sv">${p.rpg}</span></div>
            <div class="srow"><span class="sl">BLK</span><span class="sv">${p.blk}</span></div>
            ${customRows}
          </div>
          <div class="card-back-quote">"${p.quote}"</div>
          <div class="card-back-hint">tap to flip back</div>
        </div>
      </div>
    </div>
  </div>`;
}

function renderCards(){
  const grid=document.getElementById('cards-grid'); if(!grid) return;
  let toShow=sortedPlayers(PLAYERS.filter(p=>caught.has(p.id)));
  if(bearUnlocked&&caught.has(999)) toShow=[BEAR,...toShow];
  // Custom player card at the end if saved
  if(customPlayer) toShow.push(customPlayer);
  if(!toShow.length){
    grid.innerHTML=`<div style="grid-column:1/-1;font-family:'Barlow Condensed',sans-serif;color:rgba(245,240,232,.35);font-size:1rem;padding:40px 0;text-align:center">Catch players on the Map to see their cards here!</div>`;
    return;
  }
  grid.innerHTML=toShow.map(p=>buildCardHTML(p,cardCounts[p.id]||1, p.isCustom)).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDex(){
  const grid=document.getElementById('dex-grid'); if(!grid) return;
  updateCounts();
  let list=sortedPlayers(PLAYERS);
  if(bearUnlocked) list=[BEAR,...list];
  grid.innerHTML=list.map(p=>{
    const got=caught.has(p.id);
    return `<div class="dex-slot ${got?'got':''}">
      <div class="dex-char">${buildChar(p,42)}</div>
      <div class="dex-pname">${got?p.short:'???'}</div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP ‚Äî missing players banner
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateMapMissingBanner(){
  let el=document.getElementById('map-missing-banner');
  if(!el){
    el=document.createElement('div');
    el.id='map-missing-banner';
    el.className='map-legend';
    el.style.cssText='padding-top:5px;padding-bottom:5px;min-height:0';
    const legend=document.querySelector('.map-legend');
    if(legend) legend.after(el);
  }
  const missing=PLAYERS.filter(p=>!caught.has(p.id));
  if(!missing.length){
    el.innerHTML=`<span style="color:var(--teal);font-family:'Barlow Condensed',sans-serif;font-size:.82rem">üèÜ All ${PLAYERS.length} players caught!</span>`;
    return;
  }
  if(missing.length<=5){
    el.innerHTML=`<span style="color:var(--red);font-family:'Barlow Condensed',sans-serif;font-size:.8rem;font-weight:700">üî¥ ${missing.length} left: </span>`
      +missing.map(p=>`<span style="font-family:'Barlow Condensed',sans-serif;font-size:.8rem;color:rgba(245,240,232,.7);margin-left:4px">${p.short}</span>`).join('<span style="color:rgba(245,240,232,.25)"> ¬∑ </span>');
  } else {
    el.innerHTML='';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COURT ‚Äî roamers + canvas ball
// Custom player is excluded from court (cards only)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function rebuildRoamers(){
  const court=document.getElementById('roam-court');
  const footer=document.getElementById('court-footer-top');

  // Resolve roster ‚Äî custom player excluded from court
  const players=courtRoster
    .filter(id=>id!==undefined&&id!=='cp') // no custom player on court
    .map(id=>{
      if(id===999) return BEAR;
      return PLAYERS.find(p=>p.id===id);
    })
    .filter(Boolean);

  court.querySelectorAll('.roamer-div').forEach(r=>r.remove());
  if(courtAF){cancelAnimationFrame(courtAF);courtAF=null;}
  if(roamTimer){clearInterval(roamTimer);roamTimer=null;}

  const cv=document.getElementById('court-cv');
  if(cv){
    cv.width=court.offsetWidth||900; cv.height=court.offsetHeight||490;
    cv.getContext('2d').clearRect(0,0,cv.width,cv.height);
  }

  if(!players.length){
    if(footer)footer.textContent='Use the slots below to put players on the court!';
    renderRosterBar(); return;
  }
  if(footer) footer.textContent=players.length===1
    ?`${players[0].short} is warming up! üèÄ`
    :`${players.map(p=>p.short).join(', ')} running drills üèÄ`;

  players.forEach(p=>{
    // Use p.id as roamPos key ‚Äî for Bear that's 999
    const posKey=p.id;
    if(!roamPos[posKey]) roamPos[posKey]={x:20+Math.random()*60,y:20+Math.random()*60};
    const el=document.createElement('div');
    el.className='roamer-div'; el.id='rv-'+posKey;
    el.style.left=roamPos[posKey].x+'%'; el.style.top=roamPos[posKey].y+'%';
    // Use p.name for Bear (not '???') and p.short for others
    const tag=p.isBear?p.name:p.short;
    el.innerHTML=`${buildChar(p,50)}<div class="roamer-tag" style="color:${RC[p.rarity]||'#F9A01B'}">${tag}</div>`;
    court.appendChild(el);
  });

  roamTimer=setInterval(()=>{
    players.forEach(p=>{
      const pos=roamPos[p.id]; if(!pos) return;
      pos.x=Math.max(8,Math.min(92,pos.x+(Math.random()-.5)*14));
      pos.y=Math.max(10,Math.min(90,pos.y+(Math.random()-.5)*14));
      const el=document.getElementById('rv-'+p.id);
      if(el){el.style.left=pos.x+'%';el.style.top=pos.y+'%';}
    });
  },4500);

  if(players.length===1) startDribble(players[0]);
  else startPassing(players);
  renderRosterBar();
}

function startDribble(player){
  const canvas=document.getElementById('court-cv'); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  let t=0,tDir=1;
  const SPEED=0.048;
  const CHAR_H=Math.round(50*1.07);
  const ARM_X_OFF=Math.round(((52-28)/56)*50);
  const ARM_Y_UP=Math.round(((60-33)/60)*CHAR_H);
  function getHandPos(){
    const pos=roamPos[player.id]||{x:50,y:50};
    return{hx:(pos.x/100)*canvas.width+ARM_X_OFF,hy:(pos.y/100)*canvas.height-ARM_Y_UP,feetY:(pos.y/100)*canvas.height};
  }
  function drawBall(x,y,r=9){
    const g=ctx.createRadialGradient(x-r*.3,y-r*.3,r*.12,x,y,r);
    g.addColorStop(0,'#ffb347');g.addColorStop(1,'#c84800');
    ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.3)';ctx.lineWidth=1;
    ctx.beginPath();ctx.arc(x,y,r,-.45,.45);ctx.stroke();
  }
  function frame(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const{hx,hy,feetY}=getHandPos();
    const eased=Math.pow(t,0.55);
    const bx=hx, by=hy+eased*(feetY-hy-4);
    ctx.globalAlpha=0.1+0.25*eased; ctx.fillStyle='#000';
    ctx.beginPath();ctx.ellipse(bx,feetY+1,6+5*eased,2.5,0,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1; drawBall(bx,by);
    t+=tDir*SPEED; if(t>=1){t=1;tDir=-1;} if(t<=0){t=0;tDir=1;}
    courtAF=requestAnimationFrame(frame);
  }
  courtAF=requestAnimationFrame(frame);
}

function startPassing(players){
  const canvas=document.getElementById('court-cv'); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  let fromIdx=0,toIdx=1,t=0;
  const SPEED=0.012;
  function getPos(p){const pos=roamPos[p.id]||{x:50,y:50};return{x:(pos.x/100)*canvas.width,y:(pos.y/100)*canvas.height};}
  function arcPt(t,f,to){const cpX=(f.x+to.x)*.5,cpY=Math.min(f.y,to.y)-canvas.height*.28;return{x:(1-t)*(1-t)*f.x+2*(1-t)*t*cpX+t*t*to.x,y:(1-t)*(1-t)*f.y+2*(1-t)*t*cpY+t*t*to.y};}
  function drawBall(x,y){const r=9;const g=ctx.createRadialGradient(x-r*.3,y-r*.3,r*.12,x,y,r);g.addColorStop(0,'#ffb347');g.addColorStop(1,'#c84800');ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();ctx.strokeStyle='rgba(0,0,0,.25)';ctx.lineWidth=1;ctx.beginPath();ctx.arc(x,y,r,-.4,.4);ctx.stroke();}
  function frame(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const from=players[fromIdx],to=players[toIdx];
    if(!from||!to){courtAF=requestAnimationFrame(frame);return;}
    const fp=getPos(from),tp=getPos(to);t+=SPEED;
    const{x:bx,y:by}=arcPt(t,fp,tp);
    const floorY=fp.y+(tp.y-fp.y)*t,ht=Math.sin(Math.PI*t);
    ctx.save();ctx.globalAlpha=.22*ht;ctx.fillStyle='#000';ctx.beginPath();ctx.ellipse(bx,floorY+6,10*(.4+.6*ht),3,0,0,Math.PI*2);ctx.fill();ctx.restore();
    drawBall(bx,by);
    if(t>=1){t=0;fromIdx=toIdx;const others=players.map((_,i)=>i).filter(i=>i!==fromIdx);toIdx=others[Math.floor(Math.random()*others.length)];setTimeout(()=>{courtAF=requestAnimationFrame(frame);},500);return;}
    courtAF=requestAnimationFrame(frame);
  }
  courtAF=requestAnimationFrame(frame);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROSTER BAR + PICKER
// Custom player excluded from court picker
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRosterBar(){
  const bar=document.getElementById('roster-bar');
  const hint=document.getElementById('roster-hint');
  if(!bar) return;
  const MAX=5; let html='';
  for(let i=0;i<MAX;i++){
    const pid=courtRoster[i];
    if(pid!==undefined&&pid!=='cp'){
      const p=pid===999?BEAR:PLAYERS.find(pl=>pl.id===pid);
      if(p){
        const col=RC[p.rarity]||'#F9A01B';
        html+=`<div class="roster-slot filled" title="${p.name} ‚Äî tap to swap" onclick="openPicker(${i})" style="border-color:${col}">${buildChar(p,38)}</div>`;
      } else { html+=`<div class="roster-slot" onclick="openPicker(${i})">+</div>`; }
    } else { html+=`<div class="roster-slot" onclick="openPicker(${i})">+</div>`; }
  }
  bar.innerHTML=html;
  const filled=courtRoster.filter(x=>x!==undefined&&x!=='cp').length;
  if(hint) hint.textContent=filled===0?'Tap + to add players (up to 5)':'Tap any slot to swap ‚Äî hover to remove';
}

let pickerSlotIdx=null;
function openPicker(slotIdx){
  pickerSlotIdx=slotIdx;
  const grid=document.getElementById('picker-grid'); if(!grid) return;
  // Only real players + bear on court, no custom player
  const available=PLAYERS.filter(p=>caught.has(p.id));
  if(bearUnlocked&&caught.has(999)) available.push(BEAR);
  const currentInSlot=courtRoster[slotIdx];
  grid.innerHTML=available.map(p=>{
    const isThis=currentInSlot===p.id;
    const onCourt=courtRoster.includes(p.id)&&!isThis;
    return `<div class="picker-item ${isThis?'on-court':''}" onclick="selectInSlot(${JSON.stringify(p.id)})">
      <div class="pi-char">${buildChar(p,40)}</div>
      <div class="pi-name">${p.short}</div>
      ${isThis?'<div style="font-size:.5rem;color:var(--gold);font-family:\'Barlow Condensed\',sans-serif">IN THIS SLOT</div>':''}
      ${onCourt&&!isThis?'<div style="font-size:.5rem;color:rgba(245,240,232,.35);font-family:\'Barlow Condensed\',sans-serif">ON COURT</div>':''}
    </div>`;
  }).join('');
  if(currentInSlot!==undefined&&currentInSlot!=='cp'){
    grid.innerHTML+=`<div class="picker-item" onclick="clearSlot(${slotIdx})" style="border-color:var(--red);color:var(--red)">
      <div class="pi-char" style="font-size:1.4rem;height:44px;display:flex;align-items:center;justify-content:center">‚úï</div>
      <div class="pi-name">Remove</div>
    </div>`;
  }
  if(!available.length) grid.innerHTML=`<div style="font-family:'Barlow Condensed',sans-serif;color:rgba(245,240,232,.5);padding:20px;text-align:center">Catch players first!</div>`;
  document.getElementById('picker-overlay').classList.add('open');
}
function selectInSlot(pid){
  if(pickerSlotIdx===null) return;
  const existingSlot=courtRoster.indexOf(pid);
  if(existingSlot!==-1&&existingSlot!==pickerSlotIdx){
    courtRoster[existingSlot]=courtRoster[pickerSlotIdx];
  }
  courtRoster[pickerSlotIdx]=pid;
  closePicker(); cloudSave(); rebuildRoamers(); renderRosterBar();
}
function clearSlot(slotIdx){
  courtRoster.splice(slotIdx,1,undefined);
  while(courtRoster.length&&courtRoster[courtRoster.length-1]===undefined) courtRoster.pop();
  closePicker(); cloudSave(); rebuildRoamers(); renderRosterBar();
}
function closePicker(){document.getElementById('picker-overlay').classList.remove('open');pickerSlotIdx=null;}
window.openPicker=openPicker; window.selectInSlot=selectInSlot;
window.clearSlot=clearSlot; window.closePicker=closePicker;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEW SWITCHER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showView(id,btn){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  if(id==='court-view')  rebuildRoamers();
  if(id==='dex-view')    renderDex();
  if(id==='cards-view')  renderCards();
  if(id==='faces-view')  renderFaces();
  if(id==='custom-view') initCustomView();
  if(id==='map-view')    updateMapMissingBanner();
  if(id==='social-view') renderSocialView();
}
window.showView=showView;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Load local state immediately ‚Äî game is playable before Firebase resolves
lsLoad();
updateCounts();
updateMapMissingBanner();
if(bearUnlocked&&!caught.has(999)){caught.add(999);cardCounts[999]=1;}
renderCards(); renderDex(); renderFaces();
document.getElementById('total-count').textContent=PLAYERS.length;
document.getElementById('dex-total').textContent=PLAYERS.length;
document.getElementById('save-badge').style.opacity='0';
// Start spawning
scheduleAll();
if(bearUnlocked) scheduleBear();
// Autosave every 2 min
setInterval(()=>cloudSave(),120000);
// Sign in anonymously so we get a UID even for guests
signInAnonymously(auth).catch(()=>{});

</script>
</body>
</html>